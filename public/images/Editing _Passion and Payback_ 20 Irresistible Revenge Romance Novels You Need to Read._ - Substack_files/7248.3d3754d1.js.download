"use strict";(self.webpackChunksubstack=self.webpackChunksubstack||[]).push([["7248"],{74818:function(e,t,i){i.d(t,{Z:()=>r});var o=i(7409),a=i(99282),s=i(16584),n=i(64515);let r=e=>(0,s.BX)(n.l,(0,a._)((0,o._)({},e),{name:"TrashIcon",svgParams:{height:20,width:20,viewBox:"0 0 20 20"},children:[(0,s.tZ)("path",{d:"M2.51306 4.92554H4.17973H17.5131",stroke:"#666",strokeWidth:"1.5",strokeLinecap:"round",strokeLinejoin:"round"}),(0,s.tZ)("path",{d:"M6.67969 4.9255V3.25883C6.67969 2.8168 6.85528 2.39288 7.16784 2.08032C7.4804 1.76776 7.90433 1.59216 8.34635 1.59216H11.6797C12.1217 1.59216 12.5456 1.76776 12.8582 2.08032C13.1708 2.39288 13.3464 2.8168 13.3464 3.25883V4.9255M15.8464 4.9255V16.5922C15.8464 17.0342 15.6708 17.4581 15.3582 17.7707C15.0456 18.0832 14.6217 18.2588 14.1797 18.2588H5.84635C5.40433 18.2588 4.9804 18.0832 4.66784 17.7707C4.35528 17.4581 4.17969 17.0342 4.17969 16.5922V4.9255H15.8464Z",stroke:"#666",strokeWidth:"1.5",strokeLinecap:"round",strokeLinejoin:"round"})]}))},40482:function(e,t,i){i.d(t,{ZP:()=>tS});var o=i(27412),a=i(7409),s=i(99282),n=i(98848),r=i(58865),d=i(16584),l=i(6400),c=i(21834),h=i(93623),u=i(80887),p=i(141),v=i(79358),m=i(76405),g=i(92007),f=i(83311),w=i(55679),_=i(94184),y=i.n(_),b=i(27361),E=i.n(b),C=i(18446),P=i.n(C),k=i(14293),T=i.n(k),Z=i(67749),N=i(42441),x=i.n(N),S=i(80569),I=i.n(S),B=i(16564),z=i(30396),D=i(68833),L=i(98914),M=i(15771),A=i(19081),U=i(6490),R=i(58175);function F(e){var t;let{pub:i,image:o,onDone:n}=e,r=(0,z.sO)(null),l=(0,z.sO)(null),c=(0,z.sO)(null),h=(0,z.sO)(null),[u,p]=(0,z.eJ)(!1),[v,m]=(0,z.eJ)(!1),[g,f]=(0,z.eJ)(!1),[w,_]=(0,z.eJ)(65),[y,b]=(0,z.eJ)(0),[E,C]=(0,z.eJ)(0),[P,k]=(0,z.eJ)(0),[T,Z]=(0,z.eJ)(0),[N,x]=(0,z.eJ)(70),[S,B]=(0,z.eJ)(70);(0,z.d4)(()=>{if(o&&u&&v&&c.current&&l.current){let e=c.current,t=e.getContext("2d");e.width=N,e.height=S,null==t||t.drawImage(l.current,0,0,e.width,e.height)}},[S,o,u,v,N]),(0,z.d4)(()=>{if(u&&r.current&&0===P&&0===T){let e=r.current.getBoundingClientRect();k(e.right-e.left-N),Z(e.bottom-e.top-S)}},[P,u,T,N,S]),(0,z.d4)(()=>{if(c.current&&l.current){let e=c.current,t=e.getContext("2d");e.width=N,e.height=S,null==t||t.clearRect(0,0,800,800),null==t||t.drawImage(l.current,0,0,e.width,e.height)}},[N,S]),(0,z.d4)(()=>{o||m(!1)},[o]);let{node:F,pos:V,view:X}=o||{};return(null==i?void 0:i.logo_url)?(0,d.BX)(U.u_,{width:550,isOpen:!!F,onClose:n,children:[(0,d.tZ)(U.xB,{title:"Add a watermark",onClose:n,showClose:!0}),(0,d.tZ)(U.fe,{children:(0,d.BX)(A.tu,{gap:8,children:[(0,d.tZ)(R.xv.B2,{children:"Click and drag to move the watermark"}),(0,d.BX)(A.gq,{alignItems:"center",gap:8,children:[(0,d.BX)(R.xv.B3,{as:"label",for:"opacity",children:["Opacity:"," "]}),(0,d.tZ)("input",{value:w,onChange:e=>{e.target&&_(Number(e.target.value))},type:"range",min:0,max:100})]}),(0,d.BX)(A.gq,{alignItems:"center",gap:8,children:[(0,d.BX)(R.xv.B3,{as:"label",for:"width",children:["Size:"," "]}),(0,d.tZ)("input",{value:N,onChange:e=>{e.target&&x(Number(e.target.value)),e.target&&B(Number(e.target.value))},type:"range",min:0,max:800})]}),(0,d.BX)("div",{className:"imageEditorContainer-DgLGnO",onDragOver:e=>{e.preventDefault()},onDrop:e=>{k(e.clientX-y),Z(e.clientY-E)},children:[(0,d.tZ)("img",{className:"baseImage-HaDP1u",onLoad:()=>{p(!0)},ref:r,src:null==F?void 0:null===(t=F.attrs)||void 0===t?void 0:t.src}),(0,d.BX)("div",{className:"watermarkContainer-CUWRLm",style:{top:T,left:P,opacity:w/100},draggable:!0,onDragStart:e=>{b(e.clientX-P),C(e.clientY-T),p(!1);let t=e.target&&e.target.getBoundingClientRect();if(t){var i;let o=e.clientX-t.left,a=e.clientY-t.top;(null==h?void 0:h.current)&&(null===(i=e.dataTransfer)||void 0===i||i.setDragImage(null==h?void 0:h.current,o,a))}},onDragEnd:()=>{p(!0)},ref:h,children:[(0,d.tZ)("img",{ref:l,onLoad:()=>{m(!0)},style:{display:"none"},src:i.logo_url}),(0,d.tZ)("canvas",{ref:c})]})]})]})}),(0,d.tZ)(U.mz,{primaryButton:(0,d.tZ)(M.zx,{priority:"primary",onClick:async()=>{var e,t,i;(0,D.j)(D.FP.SAVE_WATERMARK_CLICKED);let o=null===(e=r.current)||void 0===e?void 0:e.getBoundingClientRect();if(o&&r.current){let e=(null==o?void 0:o.right)-o.left,d=(null==o?void 0:o.bottom)-o.top,l=(null===(t=r.current)||void 0===t?void 0:t.naturalWidth)/e,c=(null===(i=r.current)||void 0===i?void 0:i.naturalHeight)/d;f(!0);try{let e=await I().post("/api/v1/image/watermark").send({image:null==F?void 0:F.attrs.src,offsetX:Math.floor(l*P),offsetY:Math.floor(c*T),width:Math.floor(l*N),height:Math.floor(c*S),opacity:w});"number"==typeof V&&(null==X||X.dispatch(X.state.tr.setNodeMarkup(V,null,(0,s._)((0,a._)({},null==F?void 0:F.attrs),{src:e.body.url,srcNoWatermark:null==F?void 0:F.attrs.src})))),f(!1),n()}catch(e){f(!1),alert((0,L.zx)(e))}}else alert("Something went wrong")},children:g?"Saving…":"Save"}),secondaryButton:(0,d.tZ)(M.zx,{priority:"secondary",onClick:n,children:"Cancel"})})]}):null}var V=i(93666),X=i(347),O=i(74818),W=i(95741),H=i(1148);function q(e){let{children:t,isOpen:i,header:o,button:a="Done",onDone:s}=e;return(0,d.BX)(d.HY,{children:[(0,d.tZ)("div",{className:"post-editor-file-edit-sidebar file-sidebar-blackout ".concat(i?"open":"")}),(0,d.BX)("div",{className:"post-editor-file-edit-sidebar file-sidebar ".concat(i?"open":""),children:[(0,d.BX)("div",{className:"file-sidebar-header",children:[(0,d.tZ)("div",{className:"file-sidebar-header-text",children:o}),(0,d.tZ)("div",{className:"file-sidebar-header-button",onClick:s,children:a})]}),t]})]})}function j(e){var t,i,o,a,s;let{node:n,onDone:r}=e,[l,c]=(0,z.eJ)(null==n?void 0:null===(t=n.attrs)||void 0===t?void 0:t.thumbnail),[h,u]=(0,z.eJ)(null==n?void 0:null===(i=n.attrs)||void 0===i?void 0:i.description),[p,v]=(0,z.eJ)(!1),[m,g]=(0,z.eJ)(null);return(0,z.d4)(()=>{var e,t;c(null==n?void 0:null===(e=n.attrs)||void 0===e?void 0:e.thumbnail),u(null==n?void 0:null===(t=n.attrs)||void 0===t?void 0:t.description)},[null==n?void 0:null===(o=n.attrs)||void 0===o?void 0:o.thumbnail,null==n?void 0:null===(a=n.attrs)||void 0===a?void 0:a.description]),(0,z.d4)(()=>{n||(c(null),u(null),g(null))},[n]),(0,d.BX)(q,{isOpen:!!n,header:"File Settings",onDone:r,children:[(0,d.BX)("div",{className:"file-sidebar-item-text-input",children:[(0,d.tZ)("div",{className:"file-sidebar-item-text-label",children:"Title"}),(0,d.tZ)("input",{className:"file-sidebar-item-text-input-editable",type:"text",placeholder:"Add a title...",value:null==n?void 0:null===(s=n.attrs)||void 0===s?void 0:s.title,onInput:e=>{var t;null==n||null===(t=n.updateTitle)||void 0===t||t.call(n,e.target.value)}})]}),(0,d.BX)("div",{className:"file-sidebar-item-text-input",children:[(0,d.tZ)("div",{className:"file-sidebar-item-text-label",children:"Description"}),(0,d.tZ)("textarea",{className:"file-sidebar-item-text-input-editable-multiline",placeholder:"Add a description...",value:h,onInput:e=>{var t;null==n||null===(t=n.updateDescription)||void 0===t||t.call(n,e.target.value)}})]}),(0,d.BX)("div",{className:"file-sidebar-item",children:[(0,d.BX)("div",{className:"file-sidebar-upload-label",children:[(0,d.tZ)("div",{className:"file-sidebar-item-label",children:"Thumbnail"}),(0,d.tZ)("div",{className:"file-sidebar-item-sublabel",children:"Will be cropped to a 3:2 aspect ratio"})]}),l&&!p?(0,d.BX)("div",{className:"file-sidebar-item-button",onClick:async()=>{var e;await (null==n?void 0:null===(e=n.updateThumbnail)||void 0===e?void 0:e.call(n,null)),c(null)},children:[(0,d.tZ)("div",{className:"file-sidebar-item-button-icon",children:(0,d.tZ)(O.Z,{})}),"Remove"]}):(0,d.BX)(d.HY,{children:[(0,d.BX)("label",{className:"file-sidebar-item-button".concat(p?" disabled":""),for:"file-sidebar-file-input",children:[(0,d.tZ)("div",{className:"file-sidebar-item-button-icon",children:(0,d.tZ)(W.Z,{})}),"Upload"]}),(0,d.tZ)("input",{id:"file-sidebar-file-input",className:"file-sidebar-item-hidden-file-input",type:"file",accept:"image/*",onInput:async e=>{var t,i;let o=null===(t=e.target)||void 0===t?void 0:t.files[0];if(o.type.indexOf("svg")>0){let e=Error();e.message="svg images are not supported for thumbnails, please use another image format.",g(e);return}g(null),v(!0);let a=await (null==n?void 0:null===(i=n.updateThumbnail)||void 0===i?void 0:i.call(n,o,400,{aspect:1.5,crop:"fill",gravity:"auto",quality:"auto:best",width:400,height:600}).catch(e=>{g(e),v(!1)}));a&&c(a)},children:"upload"})]})]}),p?(0,d.tZ)("div",{className:"file-sidebar-item-thumbnail-placeholder",children:(0,d.tZ)(H.O,{})}):null,l?(0,d.tZ)("img",{className:"file-sidebar-item-thumbnail".concat(p?"-loading":""),src:l,onLoad:()=>{v(!1)},onError:e=>{c(null),g(e),v(!1)}}):null,m?(0,d.tZ)("p",{className:"file-sidebar-error-message",children:m.message?m.message:"there was an error while attempting to use your file as a thumbnail, please try again."}):null]})}var K=i(50515),$=i(14017);let J=new g.Sy({filterTransaction:(e,t)=>{let i=!0,o=[];return e.steps.forEach(e=>{(e instanceof f.Pu||e instanceof f.FC)&&o.push(e)}),o.forEach(e=>{let o=Math.max(0,e.from),a=Math.min(e.to,t.doc.content.size);if(o>=t.doc.content.size)return i;o!==a&&t.doc.nodesBetween(o,a,e=>{"referralTier"===e.type.name&&(i=!1)})}),i}});var Y=i(68303);class G{constructor(e){var t;(0,o._)(this,"_open",void 0),(0,o._)(this,"tooltip",void 0),(0,o._)(this,"scrollParent",void 0),(0,o._)(this,"view",void 0),(0,o._)(this,"update",(e,t)=>{let i;let o=e.state;if(t&&t.doc.eq(o.doc)&&t.selection.eq(o.selection))return;"node"in o.selection&&(i=o.selection.node);let{empty:a}=o.selection;if(a||!i||"embeddedPublication"!==i.type.name){this._open&&(this.tooltip.style.display="none",this.removeEventListeners(),this._open=!1);return}this.tooltip.style.display="block",this.tooltip.classList.toggle("show-subscribe",i.attrs.show_subscribe),this.view=e,this.place(),this._open||this.addEventListeners(),this._open=!0}),(0,o._)(this,"place",()=>{if(!this.view)return;let e=this.tooltip.offsetParent||document.body,t=(0,Y.$y)(this.view.coordsAtPos(this.view.state.selection.from));this.tooltip.style.top="".concat(t.top-this.tooltip.clientHeight,"px"),this.tooltip.style.left="".concat(Math.round(e.clientWidth/2)-Math.round(this.tooltip.clientWidth/2),"px")}),(0,o._)(this,"addEventListeners",()=>{window.addEventListener("resize",this.place),this.scrollParent.addEventListener("scroll",this.place)}),(0,o._)(this,"removeEventListeners",()=>{window.removeEventListener("resize",this.place),this.scrollParent.removeEventListener("scroll",this.place)}),(0,o._)(this,"destroy",()=>{this._open=!1,this.tooltip.remove()}),(0,o._)(this,"onClick",async()=>{let e;if(!this.view)return;let{tr:t,selection:i}=this.view.state;if("node"in i&&(e=i.node),!e)return;let{show_subscribe:o}=e.attrs;t.setNodeMarkup(i.from,e.type,(0,s._)((0,a._)({},e.attrs),{show_subscribe:!o})),this.view.dispatch(t)}),this._open=!1,this.tooltip=document.createElement("div"),this.tooltip.className="embed-publication-tooltip",this.tooltip.style.display="none",this.tooltip.addEventListener("click",this.onClick),null===(t=e.dom.parentNode)||void 0===t||t.appendChild(this.tooltip),this.scrollParent=this.tooltip.closest(".editor-scroll")||document.getElementsByClassName("editor-scroll")[0],this.update(e,null)}}let Q=new g.Sy({view:e=>new G(e)});var ee=i(39693),et=i.n(ee),ei=i(44908),eo=i.n(ei),ea=i(80983),es=i(26805),en=i(60308),er=i(84864),ed=i(54809);class el{setPlugin(e){this.plugin=e}setEditor(e){this.editor=e}async maybeCreatePost(){if(!this.editor||!("maybeCreatePost"in this.editor))return;let e=this.editor;await e.maybeCreatePost()}getInsertPos(e){if(this.editor)return this.editor.getInsertPos(e)}dispatchAlerts(e){this.editor&&this.editor.handleDropFileErrors(e)}get schema(){var e,t;return null===(t=this.editor)||void 0===t?void 0:null===(e=t.editorView)||void 0===e?void 0:e.state.schema}get view(){return this.editor?this.editor.editorView:null}get pub(){var e;return null===(e=this.editor)||void 0===e?void 0:e.props.pub}get post(){var e,t;return null===(t=this.editor)||void 0===t?void 0:null===(e=t.state)||void 0===e?void 0:e.post}addNewline(e){e.dispatch(e.state.tr.insertText("\r",e.state.doc.nodeSize-2))}drop(e,t){return!!this.shouldHandleDrop(t)&&(this.handleDropEvent(t),!0)}async getFilesToHandle(e){let t=[];for(let i of e)await this.shouldHandleFile(i)&&t.push(i);return t}async getFilesToReject(e){let t=[];for(let i of e)await this.shouldHandleFile(i)||t.push(i);return t}shouldHandleDrop(e){var t,i,o;let a=(null==e?void 0:null===(t=e.dataTransfer)||void 0===t?void 0:t.files)||[];return!!a.length&&(null===(o=a[0])||void 0===o?void 0:null===(i=o.type)||void 0===i?void 0:i.indexOf("image/"))!==0}async handleDropEvent(e){var t;e.preventDefault();let i=Array.from((null===(t=e.dataTransfer)||void 0===t?void 0:t.files)||[]);await this.handleRejections(i),await this.maybeCreatePost(),await this.processFiles(e,i)}async handleRejections(e){let t=await this.getFilesToReject(e);(null==t?void 0:t.length)&&((0,D.j)(D.FP.FILES_REJECTED,{files:t.map(e=>Object.assign({},e))}),this.dispatchAlerts(t))}handleUploadError(e,t){return e.error=t,e.error.details=(0,d.BX)("p",{children:["We were unable to add ",(0,d.tZ)("b",{children:e.name}),". Please try again and if the problem persists, contact us at"," ",(0,d.tZ)("a",{href:"mailto:support@substack.com",target:"_blank",rel:"noopener",children:"support@substack.com"})]}),this.dispatchAlerts([e]),{filename:e.name,filetype:e.assignedType||e.type,filesize:e.size,title:ec(e.name),dirty:!0,error:{message:"Unable to upload file",button:"Try again"}}}async processFile(e){var t,i;let o=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;if((null===(t=e.type)||void 0===t?void 0:t.startsWith("audio/"))&&this.editor&&"openAudioDnDModal"in this.editor)this.editor.openAudioDnDModal(e);else if((null===(i=e.type)||void 0===i?void 0:i.startsWith("video/"))&&this.editor&&"openVideoModal"in this.editor)this.editor.openVideoModal(e);else if(this.view){let t=es.Z.addFile(this.view,o,e),i=await this.uploadFile(e).catch(t=>this.handleUploadError(e,t));if(i){let o=this.schema;if(!o){console.warn("no schema found for file upload");return}let a=await this.createFileNode({schema:o,file:e,fileEntry:i});a&&es.Z.replace(this.view,t,a)}}}async processFiles(e,t){let i=await this.getFilesToHandle(t),o=this.getInsertPos(e);return Promise.all(i.map(e=>this.processFile(e,null!=o?o:void 0)))}fileSizeOK(e){return e.size<=er.MAX_FILE_SIZE||(e.error=Error("File too large"),e.error.details=(0,d.BX)("p",{children:["We were unable to add ",(0,d.tZ)("b",{children:e.name})," because it is larger than ",(0,er.numberToHumanFileSize)(er.MAX_FILE_SIZE),". Try reducing the file size and adding again."]}),!1)}async shouldHandleFile(e){var t,i;return!!((null===(t=e.type)||void 0===t?void 0:t.startsWith("audio/"))||(null===(i=e.type)||void 0===i?void 0:i.startsWith("video/")))||!!this.fileSizeOK(e)&&(!!await (0,ed.$B)({file:e})||(this.addUnsupportedTypeError(e),!1))}async canHandleFile(e,t){return(!!["development","test"].includes("production")||!!this.filesEnabled)&&!!await (0,ed.$B)({file:t})}addUnsupportedTypeError(e){e.error=Error("Unsupported file type"),e.error.details=(0,d.BX)("p",{children:["We were unable to add ",(0,d.tZ)("b",{children:e.name})," because it is a type of file we don't support yet. Try adding a"," ",this.getSupportedTypesString()," file instead."]})}getSupportedTypesString(){let e=(0,ed.jP)().map(e=>{let t=ea.extension(e);return t?t.toUpperCase():null});e.push("CBZ"),e.push("KFX"),e.push("KPF");let t=et()(eo()(e));return t.push("or ".concat(t.pop())),t.join(", ")}async createFileNode(e){let{file:t,fileEntry:i,schema:o}=e,a=await (0,ed.$B)({file:t});if(!a)return;let s=o.nodes[a];if(!s){console.warn("no file node found in schema for matching node name [".concat(a,"]"));return}return s.create(i)}async canReplaceFile(e){let{node:t,file:i}=e;return!!this.fileSizeOK(i)&&(!!await this.canHandleFile(t,i)||(this.addUnsupportedTypeError(i),!1))}async replaceFile(e,t){if(!await this.canReplaceFile(t)){this.dispatchAlerts([t.file]);return}t.node.startReplacing();let i=await this.uploadFile(t.file).catch(e=>this.handleUploadError(t.file,e));i.dirty=!0,i.thumbnail=t.node.attrs.thumbnail,i.title=t.node.attrs.title,i.description=t.node.attrs.description,t.node.attrs=i,t.node.stopReplacing(i.error)}async uploadFile(e){let t=await this.xhrUpload(e),i="".concat((0,en.SVA)(this.pub),"/f/").concat(t),o="".concat((0,en.SVA)(this.pub),"/api/v1/file/").concat(t);return{filename:e.name,filetype:e.assignedType||e.type,filesize:e.size,title:ec(e.name),href:i,raw_href:o,fileKey:t,dirty:!0}}async xhrUpload(e){var t;let i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:()=>({}),o=await I().post((null===(t=this.post)||void 0===t?void 0:t.id)?"/api/v1/file/".concat(this.post.id):"/api/v1/file/pub-files").send({filename:e.name,filetype:e.assignedType||e.type,filesize:e.size,title:ec(e.name)});return new Promise((t,a)=>{let{fileKey:s,url:n,fields:r}=o.body,d=new FormData;Object.keys(r).forEach(e=>d.append(e,r[e])),d.append("file",e);let l=new XMLHttpRequest;l.open("POST",n),l.upload.addEventListener("progress",i),l.upload.addEventListener("load",()=>{t(s)}),l.addEventListener("error",a),l.send(d)})}constructor(){(0,o._)(this,"filesEnabled",!1),(0,o._)(this,"plugin",void 0),(0,o._)(this,"editor",void 0)}}function ec(e){return(0,er.toTitleCase)(e.split(".")[0].split("_").join(" ").split("-").join(" "))}var eh=i(44369),eu=i(39556),ep=i(49762);class ev{destroy(){var e,t;this.dragging=!1,this.draggingAnchor=null,document.removeEventListener("click",this.closeActionsList,!1),window.removeEventListener("mousedown",this.onMouseDown,!1),window.removeEventListener("mousemove",this.onMouseMove,!1),window.removeEventListener("mouseup",this.onMouseUp,!1),this._update&&(window.removeEventListener("resize",this._update,!1),null===(t=this.scrollParent)||void 0===t||t.removeEventListener("scroll",this._update),window.removeEventListener("scroll",this._update),this._update=null),(null===(e=this.resizeContainer)||void 0===e?void 0:e.parentNode)&&this.resizeContainer.parentNode.removeChild(this.resizeContainer),this.resizeContainer=null,this.resizeBox=null,this.resizeLeftAnchor=null,this.resizeRightAnchor=null,this.actionsList=null,this.altTextAnchor=null}update(e,t){var i,o,a,s;let n;if(t&&t.doc.eq(e.state.doc)&&t.selection.eq(e.state.selection)||!e.state.selection)return;let r=e.state.selection;if(r.empty||!(r instanceof g.qv)){(null===(o=this.resizeContainer)||void 0===o?void 0:o.parentNode)&&this.resizeContainer.parentNode.removeChild(this.resizeContainer);return}if(!["image2","captionedImage"].includes(r.node.type.name)){(null===(a=this.resizeContainer)||void 0===a?void 0:a.parentNode)&&this.resizeContainer.parentNode.removeChild(this.resizeContainer);return}if("captionedImage"===r.node.type.name?r.node.descendants(e=>{if("image2"===e.type.name)return n=e,!1}):"image2"===r.node.type.name&&(n=r.node),n){let t=function(e){let{rootNode:t,node:i}=e,o=null;return t.descendants((e,t)=>e!==i||(o=t,!1)),o}({rootNode:e.state.doc,node:n});null!==t&&(this.imageNodePos=t)}if(this.imageNode&&this.imageNode!==n&&this.onMouseUp(),this.imageNode=n,n&&this.imageNodePos){let t=this.getParentRect(),i=e.coordsAtPos(this.imageNodePos),o=e.coordsAtPos(this.imageNodePos+1),a=this.getImageSize();this.resizeContainer&&(this.resizeContainer.style.top="".concat(i.top-t.top,"px"),this.resizeContainer.style.left="".concat(i.left-t.left,"px"),this.resizeContainer.style.height="".concat(o.top-i.top,"px"),this.resizeContainer.style.width="".concat(i.right-i.left,"px"),this.resizeContainer.className=y()("image-resize-container",{"sizing-normal":"normal"===a,"sizing-large":"large"===a,"sizing-full":"full"===a,"sizing-half":"half"===a})),this.resizeLeftAnchor&&(this.resizeLeftAnchor.style.display=""),this.resizeRightAnchor&&(this.resizeRightAnchor.style.display=""),this.dotMenuButton.style.top="",this.dotMenuButton.style.right="","image/webp"===n.attrs.type&&this.watermarkButton?this.watermarkButton.style.display="none":this.watermarkButton&&(this.watermarkButton.style.display="",this.watermarkButton.innerText=n.attrs.srcNoWatermark?"Remove watermark":"Add watermark",this.watermarkAnchor&&(this.watermarkAnchor.title=n.attrs.srcNoWatermark?"Remove watermark":"Add watermark")),this.resizeContainer&&(null===(s=e.dom.parentNode)||void 0===s||s.appendChild(this.resizeContainer)),this.setBoxSize()}else(null===(i=this.resizeContainer)||void 0===i?void 0:i.parentNode)&&this.resizeContainer.parentNode.removeChild(this.resizeContainer)}getParentRect(){var e;return((null===(e=this.resizeContainer)||void 0===e?void 0:e.offsetParent)||document.body).getBoundingClientRect()}getImageSize(){var e,t;return(null===(e=this.imageNode)||void 0===e?void 0:e.attrs.fullscreen)?"full":(null===(t=this.imageNode)||void 0===t?void 0:t.attrs.imageSize)||"normal"}getMinImageWidth(){var e,t;return Math.min(...[null===(e=this.imageNode)||void 0===e?void 0:e.attrs.resizeWidth,null===(t=this.imageNode)||void 0===t?void 0:t.attrs.width,48].filter(e=>e))}getMaxImageWidth(){let e=this.getImageSize(),{clientWidth:t}=document.documentElement;return"full"===e?t:"large"!==e&&this.resizeContainer?this.resizeContainer.getBoundingClientRect().width:t-30}setBoxSize(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0;if(!this.imageNode||!this.resizeBox)return;let t=this.imageNode.attrs.width/this.imageNode.attrs.height,i=this.getImageSize(),o=this.getMaxImageWidth(),a=Math.min(Math.max(("full"===i?o:Math.min(this.imageNode.attrs.resizeWidth||this.imageNode.attrs.width,o))+e,this.getMinImageWidth()),o),s=a/t;this.resizeBox.style.width="".concat(a,"px"),this.resizeBox.style.height="".concat(s,"px"),this.resizeBox.style.marginLeft="".concat(-a/2,"px"),this.resizeIndicator&&(this.resizeIndicator.innerText="".concat(Math.round(a)," x ").concat(Math.round(s)))}constructor(e,{scrollParent:t,disableLargeSize:i,pub:n}={}){let r,d,l,c;var h,u,p=this;(0,o._)(this,"view",void 0),(0,o._)(this,"resizeContainer",void 0),(0,o._)(this,"resizeBox",void 0),(0,o._)(this,"resizeLeftAnchor",void 0),(0,o._)(this,"resizeRightAnchor",void 0),(0,o._)(this,"resizeIndicator",void 0),(0,o._)(this,"actionsList",void 0),(0,o._)(this,"altTextAnchor",void 0),(0,o._)(this,"watermarkButton",void 0),(0,o._)(this,"watermarkAnchor",void 0),(0,o._)(this,"fullbleedAnchor",void 0),(0,o._)(this,"dotMenuButton",void 0),(0,o._)(this,"scrollParent",void 0),(0,o._)(this,"_update",void 0),(0,o._)(this,"dragging",void 0),(0,o._)(this,"imageNode",void 0),(0,o._)(this,"imageNodePos",void 0),(0,o._)(this,"originalPageX",void 0),(0,o._)(this,"draggingAnchor",null),(0,o._)(this,"originalWidth",void 0),(0,o._)(this,"pub",void 0),(0,o._)(this,"onMouseDown",e=>{if(e.target===this.resizeLeftAnchor)this.draggingAnchor="left";else{if(e.target!==this.resizeRightAnchor)return;this.draggingAnchor="right"}e.preventDefault(),this.dragging=!0,this.resizeContainer?(0,L.cn)(this.resizeContainer,"resizing"):console.warn("this.resizeContainer is null"),this.originalPageX=e.pageX,this.originalWidth=this.resizeBox?parseInt(this.resizeBox.style.width):void 0}),(0,o._)(this,"onMouseMove",e=>{let t;if(!this.dragging||T()(this.originalPageX)||T()(this.originalWidth))return;let i=e.pageX-this.originalPageX;t="right"===this.draggingAnchor?this.originalWidth+2*i:this.originalWidth-2*i,this.setBoxSize(t-this.originalWidth)}),(0,o._)(this,"onMouseUp",()=>{if(!this.dragging||!this.resizeBox||(this.dragging=!1,this.draggingAnchor=null,!this.resizeBox))return;let e=this.getMaxImageWidth(),t=Math.min(Math.max(parseInt(this.resizeBox.style.width),this.getMinImageWidth()),e),i=t>=e?e:t;this.resizeContainer?(0,L.IV)(this.resizeContainer,"resizing"):console.warn("this.resizeContainer is null"),this.imageNode&&!T()(this.imageNodePos)&&this.imageNode.attrs.resizeWidth!==i&&(this.view.dispatch(this.view.state.tr.setNodeMarkup(this.imageNodePos,this.imageNode.type,Object.assign({},this.imageNode.attrs,{resizeWidth:i}),this.imageNode.marks)),this.update(this.view)),this.originalPageX=void 0,this.originalWidth=void 0}),(0,o._)(this,"setSize",function(e,t){let i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null;e.preventDefault(),e.stopPropagation();let{view:o}=p;if(T()(p.imageNodePos)){console.warn("this.imageNodePos isNil, cannot set size");return}if(!p.imageNode){console.warn("this.imageNode missing, cannot set size");return}if(!p.resizeContainer){console.warn("this.resizeContainer missing, cannot set size");return}o.dispatch(o.state.tr.setNodeMarkup(p.imageNodePos,null,(0,s._)((0,a._)({},p.imageNode.attrs),{fullscreen:!1,imageSize:t,align:"half"===t?i:"center",resizeWidth:"normal"===t?Math.min(p.imageNode.attrs.width,p.resizeContainer.getBoundingClientRect().width):"large"===t?1200:"half"===t?600:null})))}),(0,o._)(this,"onImageEditClick",e=>{e.preventDefault(),e.stopPropagation();let{imageNode:t,imageNodePos:i,view:o,pub:n}=this;if(null==t||null==i){console.warn("this.imageNodePos is missing, cannot edit image");return}(0,eu.N)(t.attrs.src,{trackingProps:{surface:"post"},pub:n,handleEvent(e){switch(e){case"processstart":o.dispatch(o.state.tr.setNodeAttribute(i,"isProcessing",!0));break;case"processerror":case"processabort":o.dispatch(o.state.tr.setNodeAttribute(i,"isProcessing",!1))}}}).then(e=>{o.dispatch(o.state.tr.setNodeMarkup(i,t.type,(0,s._)((0,a._)({},t.attrs),{src:e.url,href:null,width:e.imageWidth,height:e.imageHeight,bytes:e.bytes,type:e.contentType,isProcessing:!1}),t.marks))})}),(0,o._)(this,"onAltTextClick",e=>{e.preventDefault(),e.stopPropagation();let{view:t}=this;if(T()(this.imageNode)){console.warn("this.imageNodePos is missing, cannot edit alt text");return}let i={parent:"Edit alt text",position:(e,t)=>{t.style.right="28px",t.style.left="unset",e.style.top="36px",e.style.right="-28px"},root:this.altTextAnchor,fields:{alt:new eh.nv({label:"Alt text:",value:this.imageNode.attrs.alt||"",required:!1})},title:"New alt text...",value:this.imageNode.attrs.alt||"",onClose:this.closeActionsList,onSubmit:e=>{let{alt:i}=e;if(i){if(T()(this.imageNode)){console.warn("this.imageNode is missing, cannot edit alt text");return}if(T()(this.imageNodePos)){console.warn("this.imageNodePos is missing, cannot edit alt text");return}t.dispatch(t.state.tr.setNodeMarkup(this.imageNodePos,null,(0,s._)((0,a._)({},this.imageNode.attrs),{alt:i})))}}};(0,eh.cS)(i)}),(0,o._)(this,"onWatermarkClick",e=>{e.preventDefault(),e.stopPropagation();let{view:t}=this;if(T()(this.imageNodePos)){console.warn("this.imageNodePos is missing, cannot add watermark");return}if(T()(this.imageNode)){console.warn("this.imageNode is missing, cannot add watermark");return}this.imageNode.attrs.srcNoWatermark?((0,D.j)(D.FP.REMOVE_WATERMARK_CLICKED),t.dispatch(t.state.tr.setNodeMarkup(this.imageNodePos,null,(0,s._)((0,a._)({},this.imageNode.attrs),{src:this.imageNode.attrs.srcNoWatermark,srcNoWatermark:null})))):((0,D.j)(D.FP.ADD_WATERMARK_CLICKED),t.dispatchEvent({type:"image_watermark",node:this.imageNode,pos:this.imageNodePos,view:t}))}),(0,o._)(this,"onCaptionImageClick",e=>{let t;e.preventDefault(),e.stopPropagation();let{view:i}=this;if(T()(this.imageNodePos)){console.warn("this.imageNodePos is missing, cannot add caption");return}let o=i.state.tr;o.doc.resolve(this.imageNodePos).node().forEach(e=>{if(e.type===i.state.schema.nodes.caption)return t=e,!1}),t&&t.type===i.state.schema.nodes.caption||(t=i.state.schema.nodes.caption.create(null,i.state.schema.text("caption...")),o.insert(this.imageNodePos+1,t));let a=o.doc.resolve(this.imageNodePos+2);o.setSelection(g.Bs.create(o.doc,a.start(),a.end())),i.dispatch(o),i.focus(),this.closeActionsList()}),(0,o._)(this,"deleteImage",e=>{e.stopPropagation(),this.view.dispatch(this.view.state.tr.deleteSelection()),this.update(this.view)}),(0,o._)(this,"isSelectableImageNode",e=>e&&e.type===this.view.state.schema.nodes.image2&&e.attrs.width&&e.attrs.height),(0,o._)(this,"handleDotMenuClick",e=>{var t;e.preventDefault(),e.stopPropagation(),(null===(t=this.actionsList)||void 0===t?void 0:t.classList.contains("open"))?this.closeActionsList():this.openActionsList()}),(0,o._)(this,"openActionsList",()=>{var e;null===(e=this.actionsList)||void 0===e||e.classList.add("open")}),(0,o._)(this,"closeActionsList",()=>{var e;null===(e=this.actionsList)||void 0===e||e.classList.remove("open")});let v=(e,t)=>{var i;let o=document.createElement("div");o.className="image-action ".concat(e),o.innerText=t;let a=document.createElement("div");return a.title=t,a.className="image-action-prompt-anchor",o.appendChild(a),null===(i=this.actionsList)||void 0===i||i.appendChild(o),o};this.dragging=!1,this.view=e,this.pub=n,this.resizeContainer=document.createElement("div"),this.resizeContainer.className="image-resize-container",this.resizeBox=document.createElement("div"),this.resizeBox.className="image-resize-box",this.resizeContainer.appendChild(this.resizeBox),this.resizeLeftAnchor=document.createElement("div"),this.resizeLeftAnchor.className="image-resize-anchor left",this.resizeRightAnchor=document.createElement("div"),this.resizeRightAnchor.className="image-resize-anchor right",this.resizeBox.appendChild(this.resizeLeftAnchor),this.resizeBox.appendChild(this.resizeRightAnchor),this.resizeIndicator=document.createElement("div"),this.resizeIndicator.className="image-resize-indicator",this.resizeBox.appendChild(this.resizeIndicator);let m=document.createElement("div");m.className="image-dot-menu-button",this.resizeBox.appendChild(m),this.actionsList=document.createElement("div"),this.actionsList.classList.add("image-actions-list");let f=document.createElement("div");f.classList.add("image-action"),f.innerText="Edit image",this.actionsList.appendChild(f);let w=document.createElement("div");w.className="image-action",w.innerText="Edit caption",this.actionsList.appendChild(w);let _=document.createElement("div");_.className="image-action",_.innerText="Edit alt text",this.altTextAnchor=document.createElement("div"),this.altTextAnchor.title="Edit alt text",this.altTextAnchor.className="image-action-prompt-anchor",_.appendChild(this.altTextAnchor),this.actionsList.appendChild(_),(null==n?void 0:n.logo_url)&&(this.watermarkButton=document.createElement("div"),this.watermarkButton.className="image-action",this.watermarkButton.innerText="Add watermark",this.watermarkAnchor=document.createElement("div"),this.watermarkAnchor.title="Add watermark",this.watermarkAnchor.className="image-action-prompt-anchor",this.watermarkButton.appendChild(this.watermarkAnchor),this.actionsList.appendChild(this.watermarkButton));let y=document.createElement("div");y.className="image-actions-divider",this.actionsList.appendChild(y);let b=v("set-normal","Normal width"),E=(0,ep.default)("enable_aligned_images");!i&&(r=v("set-large","Wide width"),d=v("set-full","Full width"),E&&(l=v("set-half-left","Half width (Left)"),c=v("set-half-right","Half width (Right)")));let C=document.createElement("div");C.className="image-actions-divider",this.actionsList.appendChild(C);let P=document.createElement("div");P.className="image-action destructive",P.innerText="Delete image",this.actionsList.appendChild(P),m.appendChild(this.actionsList),this.dotMenuButton=m,this.scrollParent=t&&document.querySelector&&document.querySelector(t)||"undefined"!=typeof window&&window||null,"undefined"!=typeof window&&(document.addEventListener("click",this.closeActionsList,!1),P.addEventListener("click",this.deleteImage,!1),f.addEventListener("click",this.onImageEditClick,!1),m.addEventListener("click",this.handleDotMenuClick,!1),w.addEventListener("click",this.onCaptionImageClick,!1),_.addEventListener("click",this.onAltTextClick,!1),null===(h=this.watermarkButton)||void 0===h||h.addEventListener("click",this.onWatermarkClick,!1),b.addEventListener("click",e=>this.setSize(e,"normal"),!1),i||(null==r||r.addEventListener("click",e=>this.setSize(e,"large"),!1),null==d||d.addEventListener("click",e=>this.setSize(e,"full"),!1),null==l||l.addEventListener("click",e=>this.setSize(e,"half","left"),!1),null==c||c.addEventListener("click",e=>this.setSize(e,"half","right"),!1)),window.addEventListener("mousedown",this.onMouseDown,!1),window.addEventListener("mousemove",this.onMouseMove,!1),window.addEventListener("mouseup",this.onMouseUp,!1),this._update=()=>{this.update(e)},window.addEventListener("resize",this._update,!1),null===(u=this.scrollParent)||void 0===u||u.addEventListener("scroll",this._update,{passive:!0}),window.addEventListener("scroll",this._update,{passive:!0})),this.update(e)}}var em=i(88204);let eg=e=>{let t=e.nodes.horizontal_rule||e.nodes.horizontalRule;return new em.VK(/^\u2014-$/,(e,i,o,a)=>e.tr.replaceWith(o,a,t.create()))},ef=e=>(0,em.S0)(/^(\d+)[.)]\s$/,e.nodes.ordered_list||e.nodes.orderedList,t=>e.nodes.orderedList?{start:Number(t[1])}:{order:Number(t[1])},(t,i)=>i.type===e.nodes.orderedList?i.childCount+i.attrs.start===Number(t[1]):i.childCount+i.attrs.order===Number(t[1])),ew=new em.VK(/\(c\)$/,"\xa9"),e_=new em.VK(/->$/,"→"),ey=new em.VK(/<-$/,"←"),eb=new em.VK(/>>$/,"\xbb"),eE=new em.VK(/<<$/,"\xab");var eC=i(19908),eP=i(70232);class ek{destroy(){this._update&&(window.removeEventListener("resize",this._update,!1),this.scrollParent.removeEventListener("scroll",this._update,!1),this.view.dom.removeEventListener("focus",this._update,!1),this.view.dom.removeEventListener("blur",this._update,!1),this._update=null),this.tooltip.parentNode&&this.tooltip.parentNode.removeChild(this.tooltip)}update(e,t){if(t&&t.doc.eq(e.state.doc)&&t.selection.eq(e.state.selection))return;let i=(0,L.$Z)(this.view.dom,this.tooltip)&&this.getActiveLink();if(!i){this.tooltip.style.display="none";return}if(!i.pos){console.warn("cannot find pos for link",i);return}this.tooltip.style.display="block",this.link.textContent=i.href,this.link.href=i.href,(0,Y.$_)(e,i.pos,this.tooltip,this.head)}getActiveLink(){if((0,Y.gR)(this.view.state,[this.view.state.schema.nodes.image2,this.view.state.schema.nodes.image3])){if((0,Y.do)(this.view.state))return{image:!0,pos:this.view.state.selection,href:(0,Y.do)(this.view.state)}}else{let t=(0,Y.k)(this.view.state,this.markType);if(t){var e;return{image:!1,pos:t.pos,href:null===(e=t.mark)||void 0===e?void 0:e.attrs.href}}}}openLink(){this.link.href&&(this.link.href.endsWith("%%")||window.open(this.link.href,"_blank"))}onChangeClicked(e){e.preventDefault(),e.stopPropagation(),this.getActiveLink()&&(0,eP.n3)(this.view,"Mod-k")}onRemoveClicked(e){e.preventDefault(),e.stopPropagation();let t=this.getActiveLink();if(!t)return;let i=this.view.state.tr;if(t.image)(0,Y.Wi)(this.view.state,i,null);else{if(!t.pos)return;i.removeMark(t.pos.from,t.pos.to,this.markType),i.setSelection(g.Bs.create(i.doc,t.pos.from,t.pos.to))}this.view.dispatch(i),this.view.focus()}constructor(e,{scrollParent:t}={}){var i;(0,o._)(this,"tooltip",void 0),(0,o._)(this,"head",void 0),(0,o._)(this,"link",void 0),(0,o._)(this,"change",void 0),(0,o._)(this,"remove",void 0),(0,o._)(this,"view",void 0),(0,o._)(this,"markType",void 0),(0,o._)(this,"scrollParent",void 0),(0,o._)(this,"_update",void 0),this.tooltip=document.createElement("div"),this.tooltip.className="link-tooltip",this.head=document.createElement("span"),this.head.className="head",this.tooltip.appendChild(this.head),this.link=document.createElement("a"),this.link.className="link",this.link.target="_blank",this.link.href="#",this.link.addEventListener("mousedown",e=>{(0,L.vU)()&&(e.preventDefault(),e.stopPropagation()),this.openLink()},!1),this.link.addEventListener("click",e=>{(0,L.vU)()?(e.preventDefault(),e.stopPropagation()):this.openLink()},!1),this.tooltip.appendChild(this.link);let a=document.createElement("span");a.textContent=" – ",a.className="separator",this.tooltip.appendChild(a);let s=document.createElement("span");s.className="buttons",this.tooltip.appendChild(s),this.change=document.createElement("a"),this.change.textContent="Change",this.change.className="change",this.change.href="#",this.change.addEventListener("mousedown",e=>this.onChangeClicked(e),!1),this.change.addEventListener("click",e=>this.onChangeClicked(e),!1),s.appendChild(this.change),s.appendChild(document.createTextNode(" | ")),this.remove=document.createElement("a"),this.remove.textContent="Remove",this.remove.className="remove",this.remove.href="#",this.remove.addEventListener("mousedown",e=>this.onRemoveClicked(e),!1),this.remove.addEventListener("click",e=>this.onRemoveClicked(e),!1),s.appendChild(this.remove),this.view=e,this.view.dom.parentNode||console.warn("EditorView.dom does not have parentNode in link tooltip plugin"),null===(i=this.view.dom.parentNode)||void 0===i||i.appendChild(this.tooltip),this.markType=this.view.state.schema.marks.link,this.scrollParent=t&&document.querySelector&&document.querySelector(t)||window,"undefined"!=typeof window&&(this._update=()=>this.update(this.view),window.addEventListener("resize",this._update,!1),this.scrollParent.addEventListener("scroll",this._update,!1),this.view.dom.addEventListener("focus",this._update,!1),this.view.dom.addEventListener("blur",this._update,!1)),this.update(e,null)}}var eT=i(84220),eZ=i(89259),eN=i(59253),ex=i(98961),eS=i(64515);let eI=e=>(0,d.tZ)(eS.l,(0,s._)((0,a._)({},e),{name:"RecommendThinIcon",svgParams:{height:12,width:12,viewBox:"0 0 12 12",stroke:"none"},children:(0,d.tZ)("circle",{cx:"6",cy:"6",r:"4",stroke:"none"})}));var eB=i(95441),ez=i(40647),eD=i(42684),eL=i(87515),eM=i(5281),eA=i(84488),eU=i(71212),eR=i(65445),eF=i(27194),eV=i(5786),eX=i(44424),eO=i(98248),eW=i(22777);let eH=e=>{let{mediaUpload:t,active:i,onOpenSettings:o,onRemoveMedia:n,onDownloadMedia:r,onThumbnailUpdated:c}=e,{iString:h}=(0,eB.M1)(),u=t.thumbnail_id>1?(0,en.ow1)(t):null,[p,v]=(0,z.eJ)(),[m,g]=(0,z.eJ)(!u),[f,w]=(0,z.eJ)(!1),_=(0,z.sO)(null),y=async()=>{var e,t;if(!(null==_?void 0:null===(t=_.current)||void 0===t?void 0:null===(e=t.files)||void 0===e?void 0:e.length))return;let i=_.current.files[0];w(!0),await b(i),w(!1)},b=async e=>{let i=Math.round(new Date().getTime()/1e3);(0,D.j)(D.FP.EDITOR_MEDIA_SET_THUMBNAIL_UPLOAD_IMAGE_CLICKED,{media_upload_id:t.id,post_id:t.post_id});try{await I().put("/api/v1/video/upload/".concat(t.id,"/thumbnail_id")).send({thumbnail_id:i,custom_thumbnail:!0});let o=await I().post("/api/v1/video/upload/".concat(t.id,"/thumbnail_upload_url")).query({fileType:e.type,fileSize:e.size,thumbnail_id:i}),n=o.body.thumbnail_upload_url;await I().put(n).set("content-type",e.type).send(e),(0,L.pt)((0,en.ow1)(o.body.mediaUpload)),c((0,s._)((0,a._)({},o.body.mediaUpload),{updated_at:new Date})),g(!1)}catch(e){console.error(e);return}},E=async()=>{try{await I().put("/api/v1/video/upload/".concat(t.id,"/thumbnail_id")).send({thumbnail_id:0,custom_thumbnail:!0}),c((0,s._)((0,a._)({},t),{thumbnail_id:0,updated_at:new Date})),g(!0)}catch(e){console.error(e);return}};return i?(0,d.tZ)("div",{className:eW.Z.verticalMenu,children:(0,d.BX)(A.tu,{gap:8,alignItems:"end",children:[(!p||"settings"===p)&&(0,d.tZ)(eV.H,{label:h("Open Settings"),children:(0,d.tZ)(M.GI,{rounded:!0,onClick:o,children:(0,d.tZ)(eM.Z,{size:16})})}),(!p||"preview"===p)&&(0,d.tZ)(eV.H,{label:h("Free preview"),children:(0,d.tZ)(M.GI,{rounded:!0,onClick:o,children:(0,d.tZ)(eA.Z,{size:16})})}),!p&&(0,d.tZ)(eV.H,{label:h("Download"),children:(0,d.tZ)(M.GI,{rounded:!0,onClick:()=>{(0,D.j)(D.FP.EDITOR_MEDIA_DOWNLOAD_CLICKED,{media_upload_id:t.id,post_id:t.post_id}),r()},children:(0,d.tZ)(eU.Z,{size:16})})}),(!p||"thumbnail"===p)&&(0,d.tZ)(eV.H,{label:h("Background image"),children:(0,d.tZ)(eX.v2,{layerOptions:{placement:"bottom-end"},onClose:()=>v(void 0),onOpen:()=>v("thumbnail"),trigger:(0,d.tZ)(M.GI,{rounded:!0,children:(0,d.tZ)(eR.Z,{size:16})}),children:(0,d.BX)(A.tu,{gap:8,padding:8,justifyContent:"center",children:[f?(0,d.tZ)(A.gq,{className:eW.Z.loadingPlaceholder,justifyContent:"center",alignItems:"center",children:(0,d.tZ)(eO.$j,{})}):m?(0,d.tZ)(A.gq,{className:eW.Z.thumbnailPicture,justifyContent:"center",alignItems:"center",bg:"secondary",radius:"sm",children:(0,d.tZ)(eR.Z,{size:24,color:"gray"})}):(0,d.tZ)("img",{className:eW.Z.thumbnailPicture,src:null!=u?u:void 0,onError:()=>{g(!0)}}),(0,d.BX)(l.Fragment,{children:[(0,d.BX)(M.zx,{priority:"secondary",disabled:f,children:["Upload image",(0,d.tZ)("input",{type:"file",accept:"image/*",className:eW.Z.customThumbnailInput,onChange:()=>y(),ref:_})]}),(0,d.tZ)(M.zx,{priority:"destructive",disabled:f,onClick:E,children:"Remove image"})]})]})})}),!p&&(0,d.tZ)(eV.H,{label:h("Remove media"),children:(0,d.tZ)(M.GI,{rounded:!0,onClick:n,children:(0,d.tZ)(eF.Z,{size:16})})})]})}):null},eq=e=>{let{onRemoveMedia:t}=e,{iString:i}=(0,eB.M1)();return(0,d.tZ)("div",{className:eW.Z.verticalMenu,children:(0,d.tZ)(A.tu,{gap:8,alignItems:"end",children:(0,d.tZ)(eV.H,{label:i("Remove media"),children:(0,d.tZ)(M.GI,{rounded:!0,onClick:t,children:(0,d.tZ)(eF.Z,{size:16})})})})})};var ej=i(21903),eK=i(61381),e$=i(89871),eJ=i(90406);let eY=e=>{var{stroke:t=eJ.Hu,fill:i=eJ.Hu}=e,o=(0,n._)(e,["stroke","fill"]);return(0,d.BX)(eS.l,(0,s._)((0,a._)({},o),{name:"CircleCheckIcon",svgParams:{viewBox:"16 16 70 70"},children:[(0,d.tZ)("path",{stroke:t,fill:i,d:"M50,81A31,31,0,1,0,19,50,31,31,0,0,0,50,81Zm0-56A25,25,0,1,1,25,50,25,25,0,0,1,50,25Z"}),(0,d.tZ)("path",{stroke:t,fill:i,d:"M47,61a3,3,0,0,0,2.18-.94l17-18-4.36-4.12-15,15.87-7.82-7-4,4.46,10,9A3,3,0,0,0,47,61Z"})]}))},eG=e=>(0,d.BX)(eS.l,(0,s._)((0,a._)({name:"CircleCrossIcon",svgParams:{height:16,width:16,stroke:"#808080"}},e),{children:[(0,d.tZ)("path",{d:"M8.00004 14.6666C11.6819 14.6666 14.6667 11.6819 14.6667 7.99998C14.6667 4.31808 11.6819 1.33331 8.00004 1.33331C4.31814 1.33331 1.33337 4.31808 1.33337 7.99998C1.33337 11.6819 4.31814 14.6666 8.00004 14.6666Z","stroke-width":"1.5","stroke-linecap":"round","stroke-linejoin":"round"}),(0,d.tZ)("path",{d:"M10 6L6 10","stroke-width":"1.5","stroke-linecap":"round","stroke-linejoin":"round"}),(0,d.tZ)("path",{d:"M6 6L10 10","stroke-width":"1.5","stroke-linecap":"round","stroke-linejoin":"round"})]}));var eQ=i(21685);let e0=e=>{let{description:t,nonStandard:i=!1}=e;return(0,d.BX)(A.gq,{alignItems:"center",gap:8,children:[i?(0,d.tZ)(eG,{stroke:"var(--color-accent-fg-red)",width:20,height:20}):(0,d.tZ)(eY,{stroke:"var(--color-fg-tertiary)",fill:"var(--color-fg-tertiary)",width:20,height:20}),(0,d.tZ)(R.xv.B3,{color:"primary",children:t})]})},e1=e=>{let{nonStandardInputReasons:t={}}=e,{iString:i}=(0,eB.M1)();return(0,d.BX)(A.tu,{padding:24,gap:16,children:[(0,d.BX)(A.tu,{children:[(0,d.tZ)(R.xv.B2,{color:"primary",weight:"semibold",children:i("Minimize processing time")}),(0,d.tZ)(R.xv.B4,{color:"secondary",children:i("For the fastest processing time, make sure your video is format is standardized.")})]}),(0,d.BX)(A.tu,{gap:12,children:[(0,d.tZ)(e0,{nonStandard:!!t.video_resolution,description:i("1080p / 1440p (2k) or smaller")}),(0,d.tZ)(e0,{nonStandard:!!t.video_codec,description:i("H.264 video CODEC")}),(0,d.tZ)(e0,{nonStandard:!!t.video_bitrate,description:i("Bitrate 8Mbps or below")}),(0,d.tZ)(e0,{nonStandard:!!t.video_fps,description:i("Frame rate (fps) between 5 and 120")}),(0,d.tZ)(e0,{nonStandard:!!t.audio_codec,description:i("AAC audio CODEC.")}),(0,d.BX)(ep.SiteConfigGate,{configKey:"4k_video",children:[(0,d.tZ)("div",{className:"divider-i9YTLe",children:(0,d.tZ)("span",{className:"divider-text-UGkUpi",children:(0,d.tZ)(R.xv.Meta,{children:i("For 4K video")})})}),(0,d.tZ)(e0,{nonStandard:!!t.video_bitrate,description:i("2160p (4k) or smaller")}),(0,d.tZ)(e0,{nonStandard:!!t.video_bitrate,description:i("Bitrate 20Mbps or below")}),(0,d.tZ)(e0,{nonStandard:!!t.video_fps,description:i("Frame rate (fps) between 5 and 60")})]})]})]})},e2=e=>{let{cta:t,preferPlacement:i="top-center",nonStandardInputReasons:o={}}=e;return(0,d.tZ)(eQ.J,{layerClassName:"container-AgIu_0",content:(0,d.tZ)(e1,{nonStandardInputReasons:o}),preferPlacement:i,children:t})};var e6=i(82061),e4=i(88788),e8=i(71068),e3=i(55014),e5=i(15562),e7=i(77203),e9=i(55077),te=i(17564),tt=i(92039),ti=i(91432),to=i(24791),ta=i(69332);let ts={container:"container-lyMD1t",placeholder:"placeholder-BOgYtz",placeholderAudio:"placeholderAudio-aKYAF7",editorPodcast:"editorPodcast-ma0eiC",hidden:"hidden-vtni3B",videoPortal:"videoPortal-D6BRRM",filePicker:"filePicker-whMeY7"},tn=(0,eT.cn)(!1);tn.debugLabel="videoRecorderOpenAtom";let tr=e=>{let{onOpenDrawer:t,mediaUpload:i,audioExtractMediaUpload:o,audioExtractPreviewMediaUpload:a,onChange:s,onAudioExtractChange:n,isDrawerOpen:r,pub:l,postId:c,mediaType:h,transcodeProgress:u=null,postMediaComposition:p,postMediaCompositionStatus:v,postMediaCompositionDuration:m,onCancelPostMediaComposition:g}=e,{iString:f}=(0,eB.M1)(),{getConfigFor:w}=(0,ez.xR)(),_={initialize:f("Initializing..."),transcribe:f("Transcribing the video..."),trim:f("Trimming the intro..."),audio:f("Applying audio enhancements..."),video:f("Rendering the final video..."),clips:f("Generating clips...")},b=!!w("clip_focused_video_upload_flow")&&"video"===h,E=(null==p?void 0:p.workflow_state)==="processing",C=((null==i?void 0:i.state)==="uploaded"||(null==o?void 0:o.state)==="uploaded")&&!r,P=u?Math.round(u).toFixed(0):0,k=Math.max(300,(null!=m?m:0)/2),T=k-k*(u?u/100:0),Z=void 0!=m&&T>0?Math.ceil(T/60):null;return(0,d.BX)("div",{style:{position:"relative"},children:[C&&(0,d.tZ)("div",{className:ts.hidden,children:"audio"===h?(0,d.tZ)(eD.Z,{initialFile:null,pub:l,feature:B.MR.Podcast,mediaUpload:i,mediaUploadId:i.id,onChange:e=>{let{mediaUpload:t}=e;t&&s({mediaUpload:t})},mediaType:"audio",postId:c,setPostId:null}):(0,d.tZ)(e6.ZP,{initialFile:null,pub:l,videoFeature:"podcast",mediaUpload:i,mediaUploadId:i.id,audioExtractMediaUpload:o,audioExtractMediaUploadId:null==o?void 0:o.id,audioExtractPreviewMediaUpload:a,audioExtractPreviewMediaUploadId:null==a?void 0:a.id,onChange:e=>{let{mediaUpload:t}=e;t&&s({mediaUpload:t})},onAudioExtractChange:e=>{let{mediaUpload:t}=e;t&&n({mediaUpload:t})},mediaType:"video",postId:c,onOpenDrawer:t,setPostId:null,postMediaComposition:p})}),(0,d.BX)(A.tu,{className:y()(ts.placeholder,{[ts.placeholderAudio]:"audio"===h&&!E}),gap:8,onClick:r||E?void 0:()=>{(0,D.j)(D.FP.PROCESSING_EPISODE_MEDIA_CLICKED,{type:h}),t()},children:[b||!u||E?(0,d.BX)(A.tu,{gap:8,style:{width:"326px"},children:[(null!=u?u:0)>0?(0,d.tZ)(eO.uk,{percent:(null!=u?u:0)/100}):(0,d.tZ)(te.S,{multiply:!0,height:4}),(0,d.BX)(A.gq,{gap:4,justifyContent:"space-between",alignItems:"center",children:[(0,d.tZ)(R.xv.B4,{color:"primary",weight:"semibold",children:E&&v?_[v]:f("Processing")}),null!==Z?(0,d.tZ)(R.xv.B4,{color:"primary",children:"".concat(f("aprox.")," ").concat(Z," ").concat(f("minutes"))}):(null!=u?u:0)>0?(0,d.BX)(R.xv.Digit,{color:"primary",children:[P,"%"]}):null]})]}):(0,d.BX)(A.tu,{gap:8,style:{width:"326px"},children:[(0,d.tZ)(eO.uk,{percent:(null!=u?u:0)/100}),(0,d.BX)(A.gq,{justifyContent:"space-between",alignItems:"center",children:[(0,d.tZ)(R.xv.B4,{color:"primary",weight:"semibold",translated:!0,children:"Processing"}),(0,d.BX)(R.xv.Digit,{color:"primary",children:[P,"%"]})]})]}),E&&g&&(0,d.tZ)(A.hs,{position:"absolute",style:{top:10,right:10},children:(0,d.tZ)(M.zx,{rounded:!0,priority:"secondary-outline",onClick:g,children:f("Revert")})})]})]})},td=e=>{var t;let{free_podcast_url:i,pub:o,postId:n,postTitle:r,sectionId:l,podcastUpload:c,podcastPreviewUpload:h,podcast_url:u,podcast_duration:p,uploading:v,onOpenDrawer:m,isDrawerOpen:g,onRemovePodcast:f,onRemoveLegacyPodcast:w,onRemoveVideoPodcast:_,onPodcastUploadChanged:b,onPodcastPreviewUploadChanged:E,onSelectFile:C,onVideoPodcastUploadChanged:P,mediaType:k,onOpenVideoSettings:T,onPostMediaCompositionChanged:Z}=e,{iString:N}=(0,eB.M1)(),{getConfigFor:x}=(0,ez.xR)(),S=!!x("clip_focused_video_upload_flow"),{postMediaComposition:B,uploadProgress:F,transcodeProgress:V,nonStandardInputReasons:X,videoUpload:O,onVideoTranscodeUpdate:W,setPostMediaComposition:H,setTranscodeProgress:q,setTranscription:j}=(0,e$.z)(),K=(0,z.sO)(null),[$]=(0,z.eJ)("paid"),[J,Y]=(0,z.eJ)(null),G="free"===$?null:u,Q=!!G&&!c&&!(null==c?void 0:c.id),ee="free"===$?null==h?void 0:h.id:null==c?void 0:c.id,et=c?(0,en.rhs)("/api/v1/audio/upload/".concat(ee,"/src")):G,ei=(0,eZ.b9)(tn),eo=(0,to.Os)(O),ea=!!(null==c?void 0:c.id)||!!u,es=!!(null==O?void 0:O.id),er=!O&&(null==c?void 0:c.state)==="uploaded",ed=!O&&(null==h?void 0:h.state)==="uploaded",el=(null==B?void 0:B.workflow_state)==="processing",ec=es&&((null==O?void 0:O.state)==="uploaded"||er||ed||el),eh=null!==(t=o.sections.find(e=>e.id===l))&&void 0!==t?t:null,eu=(null==c?void 0:c.duration)||(null==h?void 0:h.duration)||p,[ep,ev]=(0,z.eJ)(null),[em,eg]=(0,z.eJ)(null),{setIsPodcastDrawerOpen:ef,setInitialTab:ew}=(0,eK.y)(),e_=(0,tt.rG)();(0,z.d4)(()=>{(null==O?void 0:O.state)==="transcoded"&&"clips"===("undefined"!=typeof window?(0,ta.m)(window.location.href):{}).tab&&(ew("clips"),ef({isOpen:!0}))},[]),(0,z.d4)(()=>{if(e_&&n)return null==e_?void 0:e_.listen({["post-editor:".concat(n)]:e=>{var t,i,o,a,s,n,r,d,l,c,h,u,p,v,m,g,f,w,_,y,E,C,k,T,Z,N;(null===(i=e.data)||void 0===i?void 0:null===(t=i.message)||void 0===t?void 0:t.type)==="post-editor:state-update"?((null===(n=e.data)||void 0===n?void 0:null===(s=n.message)||void 0===s?void 0:s.event)&&W(null===(m=e.data)||void 0===m?void 0:m.message.event),(null===(d=e.data)||void 0===d?void 0:null===(r=d.message)||void 0===r?void 0:r.postMediaComposition)&&H(e.data.message.postMediaComposition),(null===(c=e.data)||void 0===c?void 0:null===(l=c.message)||void 0===l?void 0:l.videoUpload)&&P({mediaUpload:e.data.message.videoUpload}),(null===(u=e.data)||void 0===u?void 0:null===(h=u.message)||void 0===h?void 0:h.audioUpload)&&b({mediaUpload:e.data.message.audioUpload}),(null===(v=e.data)||void 0===v?void 0:null===(p=v.message)||void 0===p?void 0:p.transcription)&&j(null===(g=e.data)||void 0===g?void 0:g.message.transcription)):(null===(a=e.data)||void 0===a?void 0:null===(o=a.message)||void 0===o?void 0:o.type)==="post-editor:post-media-composition-update"?((null===(w=e.data)||void 0===w?void 0:null===(f=w.message)||void 0===f?void 0:f.postMediaComposition)&&H(e.data.message.postMediaComposition),(null===(y=e.data)||void 0===y?void 0:null===(_=y.message)||void 0===_?void 0:_.postMediaCompositionStatus)&&ev(e.data.message.postMediaCompositionStatus),(null===(C=e.data)||void 0===C?void 0:null===(E=C.message)||void 0===E?void 0:E.progress)&&q(e.data.message.progress),(null===(T=e.data)||void 0===T?void 0:null===(k=T.message)||void 0===k?void 0:k.duration)&&eg(e.data.message.duration)):console.warn("non identified message type",null===(N=e.data)||void 0===N?void 0:null===(Z=N.message)||void 0===Z?void 0:Z.type)}})},[n,e_]);let ey=async()=>{if(confirm(N("This will revert your latest changes. Are you sure?"))&&B){let e=await I().delete("/api/v1/live_stream/".concat(B.live_stream_id,"/reprocess_draft/").concat(B.id));(0,D.j)(D.FP.LIVE_STREAM_PODCAST_SETTINGS_REVERT_REQUESTED,{live_stream_id:B.live_stream_id,post_id:n,post_media_composition_id:B.id}),e.body&&Z(e.body),e.body.postMediaComposition&&H(e.body.postMediaComposition)}};return(0,d.BX)("div",{className:ts.container,children:[er||ed||ec||el?(0,d.BX)("div",{children:[(0,d.tZ)(tr,{pub:o,postId:n,isDrawerOpen:g,onOpenDrawer:()=>m({mediaType:k}),mediaUpload:ec?O:er?c:h,audioExtractMediaUpload:c,audioExtractPreviewMediaUpload:h,onChange:ec?P:er?b:E,onAudioExtractChange:b,mediaType:k,transcodeProgress:V,nonStandardInputReasons:X,postMediaComposition:B,postMediaCompositionStatus:ep,postMediaCompositionDuration:em,onCancelPostMediaComposition:ey}),Object.keys(X).length>0&&(0,d.tZ)(A.tu,{style:{marginTop:16},children:(0,d.tZ)(e7.U,{type:"warn",title:N("Processing speed slow due to non-standard video formatting"),icon:()=>null,action:(0,d.tZ)(e2,{nonStandardInputReasons:X,cta:(0,d.tZ)(R.xv.B4,{color:"primary",style:{textDecoration:"underline",cursor:"pointer"},children:N("Learn more")})})})})]}):v?(0,d.tZ)(A.tu,{onClick:()=>m({mediaType:k}),className:y()(ts.placeholder,{[ts.placeholderAudio]:"audio"===k}),gap:8,position:"relative",children:S&&"video"===k?(0,d.BX)(d.HY,{children:[(0,d.tZ)(e9.k,{color:"primary-themed",forcePercentage:!0,value:null!=F?F:0,width:600}),(0,d.BX)(A.gq,{alignItems:"center",justifyContent:"space-between",style:{width:600},children:[(0,d.tZ)(R.xv.Meta,{color:"pub-secondary-text",weight:"semibold",translated:!0,children:"Uploading..."}),(0,d.tZ)(R.xv.Meta,{color:"pub-secondary-text",weight:"semibold",children:F?"".concat(Math.floor(null!=F?F:0),"%"):""})]})]}):F?(0,d.BX)(A.tu,{gap:8,style:{width:"326px"},children:[(0,d.tZ)(A.gq,{radius:"full",style:{height:"4px",backgroundColor:"var(--color-bg-tertiary)"},children:(0,d.tZ)(A.gq,{radius:"full",style:{backgroundColor:"var(--color-fg-primary)",width:"".concat(F,"%")}})}),(0,d.BX)(A.gq,{justifyContent:"space-between",alignItems:"center",children:[(0,d.tZ)(R.xv.B5,{color:"primary",size:14,weight:"semibold",translated:!0,children:"Uploading"}),(0,d.BX)(R.xv.Digit,{color:"primary",children:[null==F?void 0:F.toFixed(0),"%"]})]})]}):(0,d.BX)(A.tu,{gap:8,style:{width:"326px"},children:[(0,d.tZ)(te.S,{multiply:!0,height:4}),(0,d.tZ)(R.xv.B5,{color:"primary",size:14,weight:"semibold",translated:!0,children:"Uploading"})]})}):ea||es?(0,d.BX)(d.HY,{children:[(0,d.tZ)("div",{className:y()(ts.editorPodcast),children:O?(0,d.tZ)(e6.ZP,{initialFile:null,pub:o,videoFeature:"podcast",mediaUpload:O,mediaUploadId:O.id,audioExtractMediaUpload:c,audioExtractMediaUploadId:null==c?void 0:c.id,audioExtractPreviewMediaUpload:h,audioExtractPreviewMediaUploadId:null==h?void 0:h.id,onChange:e=>{let{mediaUpload:t}=e;null===t&&(_({skipConfirm:!0}),ef({isOpen:!1})),P({mediaUpload:t})},onAudioExtractChange:b,onAudioExtractPreviewChange:e=>{let{mediaUpload:t}=e;t&&E({mediaUpload:t}),null===t&&E({mediaUpload:null})},mediaType:"video",postId:n,onOpenDrawer:m,setVideoRecorderOpen:ei,setPostId:null,onOpenVideoSettings:T,postMediaComposition:B}):(0,d.tZ)(ti.Bm,{audioFileUrl:null!=et?et:"",hasFreePodcastUrlSet:!!i,postTitle:null!=r?r:"",podcastDuration:null!=eu?eu:0,pub:o,section:eh,podcastUpload:null!=c?c:null,podcastPreviewUpload:null!=h?h:null,editComponent:!O&&c?(0,d.tZ)(eH,{mediaUpload:c,onOpenSettings:()=>m({mediaType:"audio"}),onRemoveMedia:()=>{O?_({skipConfirm:!1}):Q?w():(f({skipConfirm:!1}),ef({isOpen:!1}))},onDownloadMedia:()=>{(0,L.Hl)(Q?et:et?(0,en.rhs)(et,{download:!0}):void 0)},onThumbnailUpdated:e=>{b({mediaUpload:(0,s._)((0,a._)({},e),{updated_at:new Date})})},active:!0}):u?(0,d.tZ)(eq,{onRemoveMedia:()=>w()}):null})}),eo&&(0,d.BX)(U.u_,{isOpen:!0,onClose:()=>{},children:[(0,d.tZ)(U.xB,{showClose:!1,title:N("Something went wrong...")}),(0,d.tZ)(U.fe,{children:N("Unfortunately, there was a problem with your podcast file upload. We'll investigate, but in the meantime, please try again, and we apologize for the inconvenience")}),(0,d.tZ)(U.mz,{showDivider:!1,direction:"row",primaryButton:(0,d.tZ)(M.zx,{onClick:()=>{_&&_({skipConfirm:!0})},priority:"primary",children:N("Got it")})})]})]}):(0,d.tZ)(A.tu,{flex:"grow",gap:8,children:(0,d.tZ)(e8.xu,{flex:"grow",children:(0,d.tZ)(e3.G,{className:ts.filePicker,dropCTA:"Drop audio/video file here",pickCTAHandler:e=>(0,d.BX)(A.gq,{gap:8,children:[(0,d.BX)(eX.v2,{trigger:(0,d.tZ)(M.zx,{priority:"secondary",leading:(0,d.tZ)(eI,{height:20,fill:"#B6B6B6"}),children:N("Record")}),children:[eL.Z.isSupported()&&(0,d.tZ)(eX.sN,{onClick:()=>{m({mediaType:"audio",skipToRecordStep:!0}),(0,D.j)(D.FP.ADD_EPISODE_MEDIA_CLICKED,{method:"record",type:"audio"})},leading:(0,d.tZ)(eN.Z,{}),children:N("Record audio")}),e4.Z.isSupported()&&(0,d.tZ)(eX.sN,{onClick:()=>{var e;null===(e=K.current)||void 0===e||e.open(),(0,D.j)(D.FP.ADD_EPISODE_MEDIA_CLICKED,{method:"record",type:"video"})},leading:(0,d.tZ)(ex.Z,{}),children:N("Record video")})]}),(0,d.tZ)(M.zx,{priority:"primary",onClick:e,children:N("Select file")})]}),onFileSelected:async e=>{if(!(e.type.startsWith("audio")||e.type.startsWith("video"))){Y(N("Please upload a valid audio or video file."));return}let t=e.type.startsWith("video");C({file:e,mediaType:t?"video":"audio"}),S&&t||m({mediaType:t?"video":"audio"})},acceptableTypes:"".concat(ej.iY,", ").concat(ej.hJ),onDrop:e=>(0,D.j)(D.FP.ADD_EPISODE_MEDIA_CLICKED,{method:"drop",type:e.type.startsWith("audio")?"audio":"video"}),onPick:e=>(0,D.j)(D.FP.ADD_EPISODE_MEDIA_CLICKED,{method:"pick",type:e.type.startsWith("audio")?"audio":"video"}),info:(0,d.BX)(A.tu,{children:[(0,d.tZ)(e2,{cta:(0,d.tZ)(R.xv.B5,{color:"primary",style:{textDecoration:"underline"},children:N("Minimize processing time")})}),(0,d.tZ)(R.xv.B5,{color:"secondary",children:N("Supported audio files are MP3, WAV, ACC")})]})})})}),(0,d.tZ)(e6.h_,{className:ts.videoPortal,children:(0,d.tZ)(e6.Bl,{ref:K,onVideoRecorded:e=>{var t;let i=new File([e],"web_recording_".concat(Date.now(),".webm"),{type:e.type});null===(t=K.current)||void 0===t||t.close(),C({mediaType:"video",file:i}),S||m({mediaType:"video",file:i})},onOpen:()=>ei(!0),onClose:()=>ei(!1),videoFeature:"podcast"})}),(0,d.tZ)(e5.W,{isOpen:!!J,title:N("Unsupported file"),description:J||"",onClose:()=>Y(null),primaryButton:(0,d.tZ)(M.zx,{priority:"primary-mono",onClick:()=>Y(null),children:N("OK")})})]})},tl=e=>(0,d.tZ)(tt.rw,{children:(0,d.tZ)(td,(0,a._)({},e))});var tc=i(66120),th=i(59543),tu=i(66440);let tp={container:"container-XMabho",voiceover:"voiceover-YFvz_C",hidden:"hidden-OyXFhL"},tv=e=>{let{onOpenDrawer:t,mediaUpload:i,onChange:o,isDrawerOpen:a,pub:s,postId:n}=e,{iString:r,language:l}=(0,eB.M1)();return(0,d.BX)(d.HY,{children:["uploaded"===i.state&&!a&&(0,d.tZ)("div",{className:tp.hidden,children:(0,d.tZ)(eD.Z,{initialFile:null,pub:s,feature:B.MR.Voiceover,mediaUpload:i,mediaUploadId:i.id,onChange:e=>{let{mediaUpload:t}=e;return o(t)},mediaType:"audio",postId:n,language:l,setPostId:null})}),(0,d.tZ)(X.h,{children:(0,d.BX)(A.tu,{flex:"grow",padding:32,bg:"secondary",radius:"md",alignItems:"center",justifyContent:"center",onClick:()=>{(0,D.j)(D.FP.PROCESSING_VOICEOVER_AUDIO_CLICKED),t()},children:[(0,d.tZ)(eO.$j,{}),(0,d.tZ)(R.xv.B4,{color:"secondary",weight:"medium",children:r("Processing voiceover")})]})})]})},tm=e=>{let{pub:t,voiceoverUpload:i,onOpenDrawer:o,isDrawerOpen:a,onRemoveVoiceover:s,onVoiceoverUploadChanged:n,postId:r}=e,l=(0,en.rhs)("/api/v1/audio/upload/".concat(null==i?void 0:i.id,"/src")),c=(null==i?void 0:i.state)==="uploaded",h=(0,to.Os)(i),{iString:u}=(0,eB.M1)();return(0,d.tZ)("div",{className:tp.container,children:c?(0,d.tZ)(tv,{pub:t,postId:r,isDrawerOpen:a,onOpenDrawer:o,mediaUpload:i,onChange:n}):(0,d.BX)(d.HY,{children:[(0,d.tZ)("div",{className:tp.voiceover,children:(0,d.tZ)(B.KH,{pub:t,mediaUploadId:null==i?void 0:i.id,autoPlay:!1})}),(0,d.BX)(eX.v2,{trigger:(0,d.tZ)(M.hU,{"aria-label":u("Podcast player actions"),size:"sm",priority:"secondary-outline",children:(0,d.tZ)(tc.Z,{size:20})}),hideOnScroll:!0,children:[(0,d.tZ)(eX.sN,{onClick:o,leading:(0,d.tZ)(th.Z,{}),children:u("Edit")}),(0,d.tZ)(eX.sN,{onClick:()=>{(0,L.Hl)(l)},leading:(0,d.tZ)(eU.Z,{}),children:u("Download")}),(0,d.tZ)(eX.sN,{onClick:()=>s({skipConfirm:!1}),leading:(0,d.tZ)(tu.Z,{}),children:u("Delete")})]}),h&&(0,d.tZ)(B.YX,{isOpen:!0,onDismiss:()=>{}})]})})};var tg=i(22747),tf=i(10047),tw=i(48884),t_=i(31377),ty=i(26111),tb=i(63651),tE=i(37175);let tC=e=>t=>{let{tr:i,node:o,pos:n,schema:r}=t;i.setSelection(g.qv.create(i.doc,n));let[d]=i.selection.ranges;d&&r.nodes.image2&&i.replaceRangeWith(d.$from.pos,d.$to.pos,r.nodes.image2.create((0,s._)((0,a._)({},o.attrs),{src:e.src,height:e.height,width:e.width})))},tP=e=>t=>{let{tr:i,node:o,pos:n,schema:r}=t;i.setSelection(g.qv.create(i.doc,n));let[d]=i.selection.ranges;d&&r.nodes.assetError&&(i.insert(d.$to.pos,r.nodes.assetError.create((0,s._)((0,a._)({},o.attrs),{url:e}))),i.delete(d.$from.pos,d.$to.pos))};var tk=i(82167),tT=i(57639),tZ=i(62092),tN=i(80870);function tx(){let e=(0,r._)(["Get ",""]);return tx=function(){return e},e}class tS extends l.Component{loadDocument(){throw Error("loadDocument must be implemented")}saveDocument(e,t){throw Error("saveDocument must be implemented")}getReadonlyPlugins(){return[]}getWritablePlugins(){return[]}getClassName(){}getBackButton(){}backButtonClose(){return!1}getStatusHeader(){}getStatus(){}getStatusClass(){}getPlaceholderText(){return null}shouldFillEditorHeight(){return!0}renderMetadata(){return null}renderHeaderExtras(){return null}renderFirst(){return null}renderAboveTitle(){return null}renderBelowSubtitle(){return null}renderBelowEditor(){return null}renderButtons(){return null}renderModals(){return null}getPostType(){return null}canSetPaywall(){return!1}hasVideoPaywall(){var e,t,i,o;return!!(null===(t=this.state.post)||void 0===t?void 0:null===(e=t.draftVideoUpload)||void 0===e?void 0:e.preview_duration)&&(null===(o=this.state.post)||void 0===o?void 0:null===(i=o.draftVideoUpload)||void 0===i?void 0:i.preview_duration)>0}hasPaywall(){return this.hasVideoPaywall()||!!(this.editorView&&(0,Y.DY)(this.editorView.state.doc.toJSON(),e=>"paywall"===e.type))}hasPodcast(){return!!this.state.doc&&(!!this.state.doc.podcast_upload_id||!!this.state.doc.podcast_url)}isEmailOnly(){return!1}hasPodcastPreview(){return!!this.state.doc&&!!this.state.doc.podcast_preview_upload_id}removePaywall(){var e;if(null===(e=this.editorView)||void 0===e?void 0:e.state){let{tr:e,schema:t}=this.editorView.state,i=0,o=!1;e.doc.descendants((e,a)=>e.type!==t.nodes.paywall||(i=a,o=!0,!1)),o&&(e.setSelection(g.qv.create(e.doc,i)).deleteSelection(),this.editorView.dispatch(e))}}renderBottomBar(){let{iString:e=e=>e}=this.props,t=this.getStatusHeader(),i=this.getStatus()||"\xa0",o=this.getStatusClass()||"";return this.state.saving?(i=e("Saving.."),o=""):this.state.savingError?(t=(0,L.zx)(this.state.savingError,e("Network Error")),i=e("Unsaved changes"),o="alert"):this.state.unsaved?(i=e("Unsaved changes"),o=""):this.state.outDated&&(t=e("Draft is out of date"),i=e("Looks like this draft has been updated elsewhere. This content has been saved, please open the working copy from draft history.")),(0,d.tZ)("div",{className:"bottom-bar",children:(0,d.BX)("div",{className:"container",children:[(0,d.BX)("div",{className:"status ".concat(o),children:[t&&(0,d.tZ)("strong",{children:t}),i]}),(0,d.tZ)("div",{className:"button-container",children:this.renderButtons()})]})})}onSaveError(e,t){}getDocument(){var e,t,i,o,a,s,n,r,d,l;return this.editorView&&this.state.doc?{title:this._titleTextarea&&this._titleTextarea.value||"",subtitle:this._subtitleTextarea&&this._subtitleTextarea.value||"",bylines:this.state.doc.bylines||[],pending_invites:this.state.doc.pending_invites||[],podcast_url:null!==(r=null===(e=this.state.doc)||void 0===e?void 0:e.podcast_url)&&void 0!==r?r:"",podcast_duration:null!==(d=null===(t=this.state.doc)||void 0===t?void 0:t.podcast_duration)&&void 0!==d?d:null,video_upload_id:(null===(i=this.state.post)||void 0===i?void 0:i.type)==="video"?(null===(o=this._videoEditor)||void 0===o?void 0:o.getMediaUploadId())||null:(null===(a=this.state.doc)||void 0===a?void 0:a.video_upload_id)||null,videoUpload:null===(s=this.state.doc)||void 0===s?void 0:s.videoUpload,podcast_upload_id:this.state.doc.podcast_upload_id,podcastUpload:this.state.doc.podcastUpload,podcast_preview_upload_id:this.state.doc.podcast_preview_upload_id,podcastPreviewUpload:this.state.doc.podcastPreviewUpload,voiceover_upload_id:this.state.doc.voiceover_upload_id,voiceoverUpload:this.state.doc.voiceoverUpload,free_podcast_url:this.state.doc.free_podcast_url,body:(0,tE.serializeDoc)(this.editorView.state.doc,{runMigrations:!0,postId:null!==(l=null===(n=this.state.post)||void 0===n?void 0:n.id)&&void 0!==l?l:null})}:null}async componentDidMount(){this.isMounted=!0,window.addEventListener("beforeunload",this.onUnload),window.addEventListener("resize",this.onResize),window.addEventListener("click",this.onWindowClick),window.addEventListener("updateDigestPostEmbed",this.updateDigestPostEmbed),window.addEventListener("convertDigestPostEmbedToLink",this.convertDigestPostEmbedToLink),window.addEventListener("convertDigestPostEmbedToEmbeddedPost",this.convertDigestPostEmbedToEmbeddedPost),window.addEventListener("deleteDigestPostEmbed",this.deleteDigestPostEmbed),x().bind(["esc"],this.focusTitle),x().bind(["command+s","ctrl+s"],this.onCommandSave),(0,L.yU)(),this.cleanEmbedResizeListener=(0,tf.J)();try{let e=await this.loadDocument();await (0,L.IW)(this,{loaded:!0,doc:e,loadedDoc:e})}catch(e){console.error("Failed to load document:",e),await (0,L.IW)(this,{loadingError:e});return}this.getWriterReferralCode(),this.setupTiptapEditor(),this.hasPaywall()&&this.state.audienceToggle&&!(0,t_.isPaidAudience)(this.state.audienceToggle)&&this.setState({audienceToggle:"only_paid"})}componentWillUnmount(){var e;clearTimeout(this._autoSaveTimeout),window.removeEventListener("resize",this.onResize),window.removeEventListener("beforeunload",this.onUnload),window.removeEventListener("click",this.onWindowClick),window.removeEventListener("updateDigestPostEmbed",this.updateDigestPostEmbed),window.removeEventListener("convertDigestPostEmbedToLink",this.convertDigestPostEmbedToLink),window.removeEventListener("convertDigestPostEmbedToEmbeddedPost",this.convertDigestPostEmbedToEmbeddedPost),window.removeEventListener("deleteDigestPostEmbed",this.deleteDigestPostEmbed),null===(e=this.cleanEmbedResizeListener)||void 0===e||e.call(this),x().unbind(["esc"],this.focusTitle),x().unbind(["command+s","ctrl+s"],this.onCommandSave),(0,L.aZ)(),this.isMounted=!1}componentDidUpdate(e,t){let i=(t.doc&&t.doc.title||"").length,o=(this.state.doc&&this.state.doc.title||"").length;if(o>45!=i>45||o>110!=i>110){var a;null===(a=this._titleTextarea)||void 0===a||a.setAutoHeight()}}onEdit(){let{force:e}=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{force:!1};if(this.readonly||!this.isMounted)return;let t=this.state.doc;(0,this.debouncedUpdateDocumentState)().then(()=>{let i=this.state.doc;if(!(!e&&(null==i?void 0:i.title)==(null==t?void 0:t.title)&&(null==i?void 0:i.subtitle)==(null==t?void 0:t.subtitle)&&P()(null==i?void 0:i.bylines,null==t?void 0:t.bylines)&&P()(null==i?void 0:i.pending_invites,null==t?void 0:t.pending_invites))||(null==i?void 0:i.podcast_url)!=(null==t?void 0:t.podcast_url)||(null==i?void 0:i.podcast_duration)!=(null==t?void 0:t.podcast_duration)||(null==i?void 0:i.video_upload_id)!=(null==t?void 0:t.video_upload_id)||(null==i?void 0:i.podcast_upload_id)!=(null==t?void 0:t.podcast_upload_id)||(null==i?void 0:i.podcast_preview_upload_id)!=(null==t?void 0:t.podcast_preview_upload_id)||(null==i?void 0:i.voiceover_upload_id)!=(null==t?void 0:t.voiceover_upload_id)||(null==i?void 0:i.body)!=(null==t?void 0:t.body)||(null==i?void 0:i.free_podcast_url)!=(null==t?void 0:t.free_podcast_url))this.setState({unsaved:!0}),this.autoSaveEnabled&&(e||(null==i?void 0:i.podcast_url)!=(null==t?void 0:t.podcast_url)||(null==i?void 0:i.podcast_duration)!=(null==t?void 0:t.podcast_duration)||(null==i?void 0:i.video_upload_id)!=(null==t?void 0:t.video_upload_id)||(null==i?void 0:i.podcast_upload_id)!=(null==t?void 0:t.podcast_upload_id)||(null==i?void 0:i.podcast_preview_upload_id)!=(null==t?void 0:t.podcast_preview_upload_id)||(null==i?void 0:i.voiceover_upload_id)!=(null==t?void 0:t.voiceover_upload_id)||(null==i?void 0:i.free_podcast_url)!=(null==t?void 0:t.free_podcast_url)?this.save():(clearTimeout(this._autoSaveTimeout),"undefined"!=typeof window&&(this._autoSaveTimeout=window.setTimeout(()=>this.save(),this.props.test?10:2e3))))})}triggerMouseEvent(e,t){if("undefined"!=typeof document){let i=new CustomEvent(t);e.dispatchEvent(i)}}renderHeader(){let{iString:e=e=>e}=this.props;return(0,d.tZ)("div",{className:"header",children:(0,d.BX)("div",{className:"container",children:[this.backButtonClose()?(0,d.tZ)(M.zx,{priority:"secondary",onClick:this.closeTab,children:e("Close")}):(0,d.tZ)(M.zx,{priority:"secondary",onClick:this.goBack,leading:(0,d.tZ)(Z.Z,{size:20}),children:this.getBackButton()||e("Back")}),this.props.title&&(0,d.tZ)("span",{children:(0,d.tZ)("b",{children:this.props.title})}),this.renderHeaderExtras()]})})}renderErrors(){var e,t,i,o;let{iString:a=e=>e}=this.props,s=this.state.errors;if(!s||0===s.length)return null;let n=()=>{if(s.pop(),this.setState({errors:s}),s.length>0)return!1},[r]=s.slice(-1);return(0,d.tZ)(V.p,{className:"file-upload-error-modal",openByDefault:!0,onBeforeClose:n,noExit:!0,children:(0,d.BX)("div",{className:"file-upload-error-modal-inner",children:[(0,d.tZ)("h3",{children:null!==(i=null==r?void 0:null===(e=r.error)||void 0===e?void 0:e.message)&&void 0!==i?i:"Something went wrong"}),(0,d.tZ)("p",{children:null!==(o=null==r?void 0:null===(t=r.error)||void 0===t?void 0:t.details)&&void 0!==o?o:"Please try again"}),(0,d.tZ)("div",{className:"file-upload-error-actions",children:(0,d.tZ)(M.zx,{priority:"destructive",onClick:n,children:a("OK")})})]})})}shouldRenderTitle(){return!!this.props.titlePlaceholder}shouldRenderSubtitle(){return!!this.props.subtitlePlaceholder}shouldRenderPodcast(){return!1}shouldRenderVideo(){return!1}shouldRenderVoiceover(){return!1}renderLoadingError(e){let{iString:t=e=>e}=this.props;return[t("Failed to load draft. "),(0,d.tZ)("a",{href:"javascript:void(0)",onClick:()=>document.location.reload(),children:t("Try again")})]}getTitle(){var e;let{iString:t=e=>e}=this.props;return(0,d.tZ)(K.Z,{ref:this.assignTitleTextarea,id:"post-title",className:"page-title mousetrap",placeholder:this.props.titlePlaceholder||t("Enter title…"),maxLength:200,autoHeight:!0,inline:!0,value:null===(e=this.state.doc)||void 0===e?void 0:e.title,onInput:()=>this.onEdit()})}getSubTitle(){var e;let{iString:t=e=>e}=this.props;return(0,d.tZ)(K.Z,{ref:this.assignSubtitleTextarea,className:"subtitle mousetrap",placeholder:this.props.subtitlePlaceholder||t("Enter subtitle…"),maxLength:200,autoHeight:!0,inline:!0,value:null===(e=this.state.doc)||void 0===e?void 0:e.subtitle,onInput:()=>this.onEdit()})}maybeRemoveBadVoiceoverAndInform(){var e;return(0,to.Os)(null===(e=this.state.doc)||void 0===e?void 0:e.voiceoverUpload)?(0,d.tZ)(B.YX,{isOpen:!0,onDismiss:()=>{this.removeVoiceover()}}):null}render(){var e,t,i,o,a,s,n,r,l,c,h,u,p,v,m,g,f,_,b,E,C,P,k,T,Z,N,x,S,I,B,z,D,L,M;let{pub:U,setIsDrawerOpen:R,setInitialDrawerTab:V,openDrawerId:O}=this.props,W="editor typography ".concat(this.props.className||""," ").concat(this.getClassName()||""," use-theme-bg");if(this.state.loadingError)return(0,d.BX)("div",{className:W,children:[this.renderMetadata(),(0,d.BX)("div",{className:"editor-scroll",children:[this.renderHeader(),(0,d.tZ)("div",{className:"main-loader",children:this.renderLoadingError(this.state.loadingError)})]})]});if(!this.state.loaded)return(0,d.BX)("div",{className:W,children:[this.renderMetadata(),(0,d.BX)("div",{className:"editor-scroll",children:[this.renderHeader(),(0,d.tZ)(A.hs,{flex:"grow",justifyContent:"center",alignItems:"center",padding:32,children:(0,d.tZ)(eO.$j,{})})]})]});let H=!!(this.state.podcastUploading||this.state.podcastPreviewUploading);return(0,d.tZ)(e$.C,{isUploadingMedia:H,podcastUpload:null!==(k=null===(e=this.state.doc)||void 0===e?void 0:e.podcastUpload)&&void 0!==k?k:null,postId:null!==(T=(null===(t=this.state.post)||void 0===t?void 0:t.id)||this.props.post_id)&&void 0!==T?T:null,videoUpload:null!==(Z=null===(i=this.state.doc)||void 0===i?void 0:i.videoUpload)&&void 0!==Z?Z:null,activePostMediaComposition:null!==(N=null===(o=this.state.doc)||void 0===o?void 0:o.activePostMediaComposition)&&void 0!==N?N:null,children:(0,d.BX)("div",{className:W,onDragOver:this.allowDropFile,children:[this.renderMetadata(),this.renderErrors(),(0,d.tZ)(j,{node:this.state.fileEdit,onDone:this.fileEditDone}),(0,d.tZ)(F,{pub:U,image:this.state.imageToWatermark,onDone:this.imageWatermarkDone}),this.renderHeader(),(0,d.tZ)(tg.j_,{isAdhocEmail:this.isEmailOnly()||this.getPostType&&["adhoc_email"].includes(null!==(x=this.getPostType())&&void 0!==x?x:""),canAddPaywall:this.canSetPaywall(),editor:this.tipTapEditor,insertImageFile:this.insertImageFile,publication:U,postId:(null===(a=this.state.post)||void 0===a?void 0:a.id)||this.props.post_id,get_coupons:this.getCoupons,insert_coupon:this.insertCoupon,setPostPaidForPaywall:this.setPostPaidForPaywall,audioEmbedsEnabled:this.getPostType&&["newsletter","thread","podcast","video","page"].includes(null!==(S=this.getPostType())&&void 0!==S?S:""),voiceoverEnabled:this.getPostType&&"newsletter"===this.getPostType(),setPostId:null===this.getPostType()?null:this.setPostId,hideSharePostAndComment:this.state.hideSharePostAndComment,showingDrawerName:O,setShowDrawer:e=>{null==R||R({drawerId:e,isOpen:!0})},writerReferralCode:this.state.writerReferralCode,disabled:!!this.state.isFrozen,user:null===(s=this.props)||void 0===s?void 0:s.user}),(0,d.tZ)(X.h,{children:(0,d.BX)("div",{className:"editor-scroll dragging",children:[(0,d.tZ)("div",{className:y()("post typography container",{disabled:this.state.isFrozen}),children:(0,d.BX)(A.tu,{gap:24,children:[(0,d.BX)(A.tu,{gap:12,children:[this.renderFirst(),this.renderAboveTitle()]}),this.shouldRenderVideo()&&(0,d.tZ)(e6.ZP,{ref:this.assignVideoEditor,pub:this.props.pub,mediaType:"video",mediaUploadId:null===(n=this.state.doc)||void 0===n?void 0:n.video_upload_id,mediaUpload:null===(r=this.state.post)||void 0===r?void 0:r.draftVideoUpload,postId:(null===(l=this.state.post)||void 0===l?void 0:l.id)||this.props.post_id,setPostId:this.setPostId,onChange:()=>{this.onEdit({force:!0})},videoFeature:"hero",initialFile:null,postMediaComposition:null!==(I=null===(c=this.state.doc)||void 0===c?void 0:c.activePostMediaComposition)&&void 0!==I?I:null}),this.shouldRenderPodcast()&&(0,d.tZ)(tl,{pub:U,sectionId:null!==(B=null===(h=this.state.post)||void 0===h?void 0:h.draft_section_id)&&void 0!==B?B:null===(u=this.state.post)||void 0===u?void 0:u.section_id,postTitle:null!==(z=null===(p=this.state.post)||void 0===p?void 0:p.draft_title)&&void 0!==z?z:null===(v=this.state.post)||void 0===v?void 0:v.title,postId:(null===(m=this.state.post)||void 0===m?void 0:m.id)||this.props.post_id,podcastUpload:null===(g=this.state.doc)||void 0===g?void 0:g.podcastUpload,podcastPreviewUpload:null===(f=this.state.doc)||void 0===f?void 0:f.podcastPreviewUpload,free_podcast_url:null!==(D=null===(_=this.state.doc)||void 0===_?void 0:_.free_podcast_url)&&void 0!==D?D:null,podcast_url:null!==(L=null===(b=this.state.doc)||void 0===b?void 0:b.podcast_url)&&void 0!==L?L:void 0,podcast_duration:null!==(M=null===(E=this.state.doc)||void 0===E?void 0:E.podcast_duration)&&void 0!==M?M:void 0,uploading:H,isDrawerOpen:"podcast"===O,onOpenDrawer:e=>{let{mediaType:t,skipToRecordStep:i,isOpen:o=!0,initialTab:a}=e;a&&(null==V||V(a)),null==R||R({isOpen:o,drawerId:"podcast",variant:"push",onOpenCallback:()=>this.setState({podcastMediaType:t,skipToRecordStep:i})})},onSelectFile:e=>{let{file:t,mediaType:i}=e;this.setState({droppedPodcastFile:t,podcastMediaType:i})},onRemovePodcast:this.removePodcast,onRemovePodcastPreview:this.removePodcastPreview,onRemoveLegacyPodcast:this.removeLegacyPodcast,onRemoveVideoPodcast:this.removeVideoPodcast,onPodcastUploadChanged:this.onPodcastUploadChanged,onPodcastPreviewUploadChanged:this.onPodcastPreviewUploadChanged,onVideoPodcastUploadChanged:this.onVideoPodcastUploadChanged,mediaType:this.state.podcastMediaType,onOpenVideoSettings:this.openVideoSettings,onPostMediaCompositionChanged:e=>{let{mediaUpload:t}=e;return this.onVideoPodcastUploadChanged({mediaUpload:t})}}),(0,d.BX)(A.tu,{gap:8,children:[this.shouldRenderTitle()&&this.getTitle(),this.shouldRenderSubtitle()&&this.getSubTitle()]}),this.renderBelowSubtitle(),this.maybeRemoveBadVoiceoverAndInform(),this.shouldRenderVoiceover()&&(0,d.tZ)(tm,{pub:U,postId:(null===(C=this.state.post)||void 0===C?void 0:C.id)||this.props.post_id,voiceoverUpload:null===(P=this.state.doc)||void 0===P?void 0:P.voiceoverUpload,onRemoveVoiceover:this.removeVoiceover,onOpenDrawer:()=>{null==R||R({isOpen:!0,drawerId:"voiceover"})},isDrawerOpen:"voiceover"===O,onVoiceoverUploadChanged:this.onVoiceoverUploadChanged}),this.tipTapEditor&&(0,d.tZ)(w.kg,{className:"post-editor markup mousetrap",editor:this.tipTapEditor}),this.renderBelowEditor()]})}),this.renderBottomBar()]})}),this.renderModals()]})})}constructor(e,t){var i;super(e,t),i=this,(0,o._)(this,"state",void 0),(0,o._)(this,"base",void 0),(0,o._)(this,"autoSaveEnabled",void 0),(0,o._)(this,"commandSaveEnabled",void 0),(0,o._)(this,"tipTapEditor",void 0),(0,o._)(this,"editorView",void 0),(0,o._)(this,"cleanEmbedResizeListener",void 0),(0,o._)(this,"heightOffset",void 0),(0,o._)(this,"readonly",void 0),(0,o._)(this,"isMounted",void 0),(0,o._)(this,"_autoSaveTimeout",void 0),(0,o._)(this,"_titleTextarea",void 0),(0,o._)(this,"_subtitleTextarea",void 0),(0,o._)(this,"_videoEditor",void 0),(0,o._)(this,"assignTitleTextarea",e=>{this._titleTextarea=e}),(0,o._)(this,"assignSubtitleTextarea",e=>{this._subtitleTextarea=e}),(0,o._)(this,"assignVideoEditor",e=>{this._videoEditor=e}),(0,o._)(this,"handleMouseover",(e,t)=>{}),(0,o._)(this,"openVideoSettings",()=>{}),(0,o._)(this,"onResize",()=>{let e=window.innerWidth>481,t=this.heightOffset||0;if(this.base&&(this.base.style.height=e?"".concat(window.innerHeight-t,"px"):""),this.shouldFillEditorHeight()&&this.editorView&&this.editorView.dom){let i=Math.max(500,window.innerHeight-395-18*!e-t);this.editorView.dom.style.minHeight="".concat(i,"px")}}),(0,o._)(this,"onUnload",e=>{let{iString:t=e=>e}=this.props;this.state.unsaved&&(e.returnValue=t("You have unsaved changes. Are you sure you want to navigate away from this page?"))}),(0,o._)(this,"onWindowClick",e=>{(0,L.rs)(e.target,e=>{var t;return"A"===e.nodeName&&/\bimage-link\b/.test(null!==(t=e.className)&&void 0!==t?t:"")})&&e.preventDefault()}),(0,o._)(this,"focusTitle",()=>{var e,t;(null===(e=this.editorView)||void 0===e?void 0:e.hasFocus())&&(null===(t=document.getElementById("post-title"))||void 0===t||t.focus())}),(0,o._)(this,"makePlugins",e=>{var t,i,o;let{schema:a}=e,s=this.props.plugins||[],n=[...this.getReadonlyPlugins()];if(this.readonly)return[...s,...n];let{pub:r}=this.props,d=[(0,em.Hw)({rules:[...em.yR,em.LH,em.pR,ew,e_,ey,eb,eE,eg(a),ef(a),(0,em.S0)(/^\s*>\s$/,a.nodes.blockquote),(0,em.S0)(/^[-*]\s$/,a.nodes.bullet_list||a.nodes.bulletList),(0,em.zK)(/^```$/,a.nodes.code_block||a.nodes.codeBlock),(0,em.zK)(RegExp("^(#{1,6})\\s$"),a.nodes.heading,e=>({level:e[1].length}))]}),(0,v.h)((0,eC.T)(a)),(0,v.h)(c.YR),(0,h.q)({width:4,color:(null==r?void 0:null===(t=r.theme)||void 0===t?void 0:t.background_pop_color)||(null==r?void 0:r.theme_var_background_pop)||eJ.Hu}),(0,u.d)(),(0,p.m8)(),es.Z,Q,function(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};return new g.Sy({view:t=>new ek(t,e)})}({scrollParent:".editor-scroll"}),function(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};return new g.Sy({view:t=>new ev(t,e)})}({scrollParent:".editor-scroll",disableLargeSize:(null!==(o=null===(i=this.state.post)||void 0===i?void 0:i.type)&&void 0!==o?o:this.props.type)==="thread",pub:r}),function(e){let{editor:t,filesEnabled:i}=e,o=arguments.length>1&&void 0!==arguments[1]?arguments[1]:new el;o.filesEnabled=i,o.setEditor(t);let a=new g.Sy({props:{handleDOMEvents:{drop:(e,t)=>o.drop(e,t),file_replace:(e,t)=>o.replaceFile(e,t)}}});return o.setPlugin(a),a}({editor:this,filesEnabled:!0}),J],l=this.getPlaceholderText();return l&&d.push(function(e){let t=t=>{t.state.doc.textContent||!(0,Y.Dc)(t.state.doc.toJSON())?t.dom.removeAttribute("data-placeholder"):t.dom.setAttribute("data-placeholder",e)};return new g.Sy({view:e=>(t(e),{update:t})})}(l)),[...s,...n,...d,...this.getWritablePlugins()]}),(0,o._)(this,"cleanUpOrphanCaptions",e=>{let{tr:t,schema:i}=e;t.doc.descendants((e,o,a)=>{let s=t.mapping.map(o);if(e.type===i.nodes.captionedImage&&e.firstChild&&e.firstChild.type!==i.nodes.image2||e.type===i.nodes.caption&&a&&a.type!==i.nodes.captionedImage){if(e.type!==i.nodes.captionedImage||!e.firstChild||e.firstChild.type!==i.nodes.blockquote)return t.delete(s,s+e.nodeSize),!1;{let e=t.doc.resolve(s+2),o=t.doc.resolve(s+3),a=new m.Ts(e,o,e.depth),n=(0,f.k9)(a);!T()(n)&&n>=0&&t.lift(a,n);let[r]=g.qv.create(t.doc,s).ranges,d=new m.Ts(null==r?void 0:r.$from,null==r?void 0:r.$to,null==r?void 0:r.$from.depth),l=(0,f.nd)(d,i.nodes.blockquote);l&&t.wrap(d,l)}}return!0})}),(0,o._)(this,"wrapOrphanImages",e=>{let{tr:t,schema:i}=e;try{t.doc.descendants((e,o,a)=>{if("image2"===e.type.name&&(null==a?void 0:a.type.name)!=="captionedImage"&&i.nodes.captionedImage){let[e]=g.qv.create(t.doc,o).ranges,a=new m.Ts(null==e?void 0:e.$from,null==e?void 0:e.$to,null==e?void 0:e.$from.depth),s=(0,f.nd)(a,i.nodes.captionedImage);s&&t.wrap(a,s)}})}catch(e){console.error(e)}}),(0,o._)(this,"hasMultipleCaptions",e=>{let{schema:t,node:i}=e,o=0;return i.forEach(e=>{e.type===t.nodes.caption&&(o+=1)}),o>1}),(0,o._)(this,"liftStubCaptions",e=>{let{tr:t,schema:i}=e;t.doc.descendants((e,o,a)=>{if(e.type===i.nodes.caption&&a&&(this.hasMultipleCaptions({schema:i,node:a})&&e===a.lastChild||a.type!==i.nodes.captionedImage)){let i=t.doc.resolve(o),a=t.doc.resolve(o+e.nodeSize),s=new m.Ts(i,a,i.depth),n=(0,f.k9)(s);!T()(n)&&n>=0&&t.lift(s,n)}}),t.doc.descendants((e,o,a)=>{e.type===i.nodes.caption&&a&&a.type!==i.nodes.captionedImage&&(t.replaceRangeWith(o,o+e.nodeSize,i.node("paragraph",null,e.content)),t.setSelection(g.Bs.create(t.doc,o+1)))})}),(0,o._)(this,"closeTab",()=>{window.close()}),(0,o._)(this,"getWriterReferralCode",async()=>{let e=await I().put("/api/v1/user/writer_referrals/code");this.setState({writerReferralCode:e.body.code})}),(0,o._)(this,"setupTiptapEditor",async()=>{var e,t,i,o,a,s;this.tipTapEditor&&(this.tipTapEditor.destroy(),this.tipTapEditor=null),this.editorView&&(this.editorView.destroy(),this.editorView=null),this.tipTapEditor=new w.ML({editorProps:this.editorProps(),extensions:tE.tipTapNodes}),this.editorView=this.tipTapEditor.view;let n=["mention$"],r=null===(i=this.tipTapEditor.state)||void 0===i?void 0:null===(t=i.config)||void 0===t?void 0:null===(e=t.plugins)||void 0===e?void 0:e.filter(e=>{var t;return n.includes(null!==(t=e.key)&&void 0!==t?t:"")}),d=null===(s=this.tipTapEditor.state)||void 0===s?void 0:null===(a=s.config)||void 0===a?void 0:null===(o=a.plugins)||void 0===o?void 0:o.filter(e=>"substack_mentions_extension$"===e.key);r&&(null==d?void 0:d[0])&&r.push(d[0]),this.editorView.setProps(this.directEditorProps({schema:this.editorView.state.schema,rolloverPlugins:null!=r?r:[]})),this.onResize(),this.uploadUnhostedImages(this.editorView,this.editorView.state.doc),this.processAugmentationPlaceholders(this.editorView,this.editorView.state.doc),this.shouldRenderPodcast()||this.shouldRenderVideo()||this.editorView.focus(),this.editorView.dom.addEventListener("mousedown",e=>{if(e.target&&e.target.classList.contains("ProseMirror")&&this.editorView&&!this.editorView.hasFocus()){var t;null===(t=this.editorView)||void 0===t||t.focus()}}),this.tipTapEditor.on("transaction",()=>{requestAnimationFrame(()=>{requestAnimationFrame(()=>{this.isMounted&&this.forceUpdate()})})})}),(0,o._)(this,"directEditorProps",e=>{var t,i;let{schema:o,rolloverPlugins:a}=e;if(!this.state.doc)return console.warn("directEditorProps called before state.doc is set"),{};let s=[...a,...this.makePlugins({schema:o})];return{state:g.yy.create({doc:(0,tE.unserializeDoc)(this.state.doc.body,{customSchema:o,useTiptap:!0,postId:null!==(i=null===(t=this.state.post)||void 0===t?void 0:t.id)&&void 0!==i?i:null}),plugins:s}),dispatchTransaction:e=>{if(this.readonly||!this.editorView)return;let t=this.editorView.state.schema;if(this.liftStubCaptions({schema:t,tr:e}),this.cleanUpOrphanCaptions({schema:t,tr:e}),this.wrapOrphanImages({schema:t,tr:e}),e.selection instanceof g.qv&&e.selection.node.type===t.nodes.image2){let i=e.doc.resolve(e.selection.from),o=i.parent;if(o&&o.type===t.nodes.captionedImage){let o=i.depth;for(let a=o;a>0;a--)if(i.node(a).type===t.nodes.captionedImage){let t=i.before(a);e.setSelection(g.qv.create(e.doc,t));break}}}(0,tN.zb)(e,t),(0,tN.A0)(e,t),(0,tN.$w)(e,t);let i=this.editorView.state.apply(e);this.editorView.updateState(i),this.onEdit()}}}),(0,o._)(this,"editorProps",()=>{let e=!this.readonly;return{attributes:{class:"mousetrap","data-testid":"editor",dir:"auto"},editable:()=>e,handleClickOn:this.handleClickOn,handleDrop:this.handleDrop,handlePaste:this.handlePaste,handleDOMEvents:{paste:(e,t)=>{var i,o,a;return!!(t.clipboardData&&t.clipboardData.items&&1===t.clipboardData.items.length&&/^image\//i.test(null!==(o=null===(i=t.clipboardData.items[0])||void 0===i?void 0:i.type)&&void 0!==o?o:""))&&(this.insertImageFile(null===(a=t.clipboardData.items[0])||void 0===a?void 0:a.getAsFile()),!0)},file_edit:this.fileEditStart,image_watermark:this.imageWatermarkStart,mouseover:this.handleMouseover},transformPastedText:this.transformPastedText,transformPastedHTML:this.transformPastedHTML}}),(0,o._)(this,"updateDocumentState",async function(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},t=Object.assign({doc:i.getDocument()},e||{});await (0,L.IW)(i,t)}),(0,o._)(this,"debouncedUpdateDocumentState",(0,eP.HF)(this.updateDocumentState,200)),(0,o._)(this,"save",async function(){let{alertForErrors:e,saveDocumentOptions:t}=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},{iString:o=e=>e}=i.props,a=null;if(!i.readonly){if(clearTimeout(i._autoSaveTimeout),i.state.pendingUploads>0||i.state.saving)return;try{if(await i.updateDocumentState({saving:!0,savingError:null}),!i.state.doc)return console.warn("save called before state.doc is set"),null;a=await i.saveDocument(i.state.doc,t),i.setState({saving:!1,savingError:null,unsaved:!1})}catch(t){console.error("Failed to save draft: ",t),i.setState({saving:!1,savingError:t}),i.onSaveError(t)||e&&alert((0,L.zx)(t,o("There was a network issue. Try again in a bit")))}return a}}),(0,o._)(this,"onCommandSave",()=>{if(this.commandSaveEnabled)return this.save(),!1}),(0,o._)(this,"canGoBack",()=>{let{iString:e=e=>e}=this.props;return this.state.unsaved?window.confirm(e("You have unsaved changes. Are you sure you want to navigate away from this page?")):null}),(0,o._)(this,"goBack",function(e){let{localNavigation:t=!0}=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};!1!==i.canGoBack()&&(e.preventDefault(),i.props.back?(0,L.uX)(i.props.back,{event:e,replace:!0,local_navigation:t}):window.history.back())}),(0,o._)(this,"handleClickOn",(e,t,i,o)=>{if(i&&i.type.name in tE.customMediaNodes)return e.dispatch(e.state.tr.setSelection(g.qv.create(e.state.doc,o))),!0}),(0,o._)(this,"transformPastedText",e=>e.replace(/\u2028/g,"\n").replace(/\u2029/g,"\n")),(0,o._)(this,"transformPastedHTML",e=>{var t,i,o,a;let s;let n=document.createElement("div");for(let o of(n.innerHTML=e,Array.from(n.querySelectorAll("h1, h2, h3, h4, h5, h6")))){let e=Array.from(o.querySelectorAll("img")),a=o.nextSibling;for(let s of e)a?null===(t=o.parentNode)||void 0===t||t.insertBefore(s,a):null===(i=o.parentNode)||void 0===i||i.appendChild(s)}for(let e of Array.from(n.querySelectorAll("li:first-child")))"700"===e.style.fontWeight&&(e.style.fontWeight="normal");for(let e of Array.from(n.querySelectorAll("b")))if("normal"===e.style.fontWeight){let t=document.createElement("span"),i=window.getComputedStyle(e),s=i.cssText;""===s&&(s=Object.values(i).reduce((e,t)=>"".concat(e).concat(t,":").concat(i.getPropertyValue(t),";"))),t.style.cssText=s,t.innerHTML=e.innerHTML,null===(o=e.parentNode)||void 0===o||o.insertBefore(t,e),null===(a=e.parentNode)||void 0===a||a.removeChild(e)}let r=document.createTreeWalker(n,NodeFilter.SHOW_TEXT,null);for(;s=r.nextNode();)s.nodeType===window.Node.TEXT_NODE&&(s.nodeValue=s.nodeValue.replace(RegExp(String.fromCharCode(160),"g")," "));return this.transformPastedText(n.innerHTML)}),(0,o._)(this,"handlePaste",(e,t,i)=>((async()=>{i=await this.replaceDigestPostEmbedUrls(e,i),i=await this.replacePostIdsInUrls(e,i),i=await this.cleanBadCaptions({schema:e.state.schema,slice:i}),i=await this.unwrapPastedFootnotes({schema:e.state.schema,slice:i}),i=await this.cleanBadPastedMarks(e,i),i=await this.unwrapPastedBlockquotes(e,i,this.tipTapEditor),i=await this.augmentPastedContent(e,i),this.uploadUnhostedImages(e,i,!0);let t=this.maybeLinkSelectedText(e,i);t||(t=1===i.content.childCount&&0===i.openStart&&0===i.openEnd&&i.content.firstChild?e.state.tr.replaceSelectionWith(i.content.firstChild):e.state.tr.replaceSelection(i)),e.dispatch(t.scrollIntoView().setMeta("paste",!0))})(),!0)),(0,o._)(this,"getActionForImagesInSlice",function(e){let t=arguments.length>1&&void 0!==arguments[1]&&arguments[1],o={};return(0,Y.je)(e,e=>{let a="assetError"===e.type.name?e.attrs.url:e.attrs.src;a!==er.MISSING_IMAGE_URL&&!o[a]&&((0,tb.chL)(a)||(0,tb.e83)(a)||a.startsWith("https://substack-post-media.s3.amazonaws.com")?t&&(o[a]=i.getHostedImageAttrs(a)):o[a]=i.uploadImage(a))},{nodeTypes:["image","image2","assetError"]}),o}),(0,o._)(this,"uploadUnhostedImages",async function(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,o=arguments.length>2&&void 0!==arguments[2]&&arguments[2],a=null!=t?t:e.state.doc;"post_id"in i.props&&await i.setPostId();let s=i.getActionForImagesInSlice(a,o);return Promise.all(Object.keys(s).map(t=>{var o;return null===(o=s[t])||void 0===o?void 0:o.then(o=>{i.transformImage(e,t,(t,i,a)=>{["image","image2"].includes(i.type.name)?t.setNodeMarkup(a,i.type,Object.assign({},i.attrs,{src:o.src,height:o.height,width:o.width}),i.marks):tC(o)({tr:t,node:i,pos:a,schema:e.state.schema})})}).catch(o=>{console.error("Failed to upload image: with url [".concat(t,"]"),o),i.transformImage(e,t,(i,o,a)=>{"assetError"!==o.type.name&&tP(t)({tr:i,node:o,pos:a,schema:e.state.schema})})})}))}),(0,o._)(this,"transformImage",(e,t,i)=>{let o=!1,a=e.state.tr;e.state.doc.descendants((e,s)=>{(["image","image2"].includes(e.type.name)&&e.attrs.src===t||"assetError"===e.type.name&&e.attrs.url===t)&&(o=!0,i(a,e,s))}),o&&e.dispatch(a)}),(0,o._)(this,"unwrapPastedFootnotes",async e=>{let{schema:t,slice:i}=e;return await (0,Y.hL)(i,async e=>e.type===t.nodes.footnoteAnchor||e.marks.length&&e.marks.some(e=>{var t,i;return null===(i=e.attrs)||void 0===i?void 0:null===(t=i.href)||void 0===t?void 0:t.startsWith("#footnote-")})?null:e.type===t.nodes.footnote&&t.nodes.fragmentNode?t.nodes.fragmentNode.create(null,e.content):e)}),(0,o._)(this,"replacePostIdsInUrls",async(e,t)=>{var i,o;let a=(null===(o=this.state)||void 0===o?void 0:null===(i=o.post)||void 0===i?void 0:i.id)||this.props.post_id;return await (0,Y.hL)(t,async e=>{var t;let i=null==e?void 0:null===(t=e.attrs)||void 0===t?void 0:t.url;try{i&&"/subscribe"===new URL(i).pathname&&(0,ty.x)(i,"coupon")&&(0,ty.x)(i,"utm_content")!==a&&(0,tZ.mR)({node:e,attrs:{url:(0,en.rhs)(i,{utm_content:a})}})}catch(e){}return e})}),(0,o._)(this,"replaceDigestPostEmbedUrls",async(e,t)=>{let{iString:i=e=>e}=this.props;return await (0,Y.hL)(t,async o=>{var n,r;let d=null===(n=(0,tZ.yX)({fragment:t.content}))||void 0===n?void 0:n[0],l=d?null===(r=(0,tZ.yX)({fragment:d.content}))||void 0===r?void 0:r[0]:void 0;if(null==l?void 0:l.marks.some(e=>"link"===e.type.name))return o;if(l&&l.type===e.state.schema.nodes.text){let t=l.text;if(t&&(0,tk.lQ)(t)&&e.state.schema.nodes.digestPostEmbed)try{let i=await (0,tk.wM)(t);return e.state.schema.nodes.digestPostEmbed.create((0,s._)((0,a._)({},i),{isEditorNode:!0,nodeId:(0,L.EH)()}))}catch(e){console.error(e),alert(i("Failed to find post. Please check the link and try again."))}}return o})}),(0,o._)(this,"cleanBadCaptions",async e=>{let{schema:t,slice:i}=e;return await (0,Y.hL)(i,async e=>{if(e.type===t.nodes.captionedImage){let i=(0,tZ.yX)({fragment:e.content});if(!i.length||!i[0]||i[0].type!==t.nodes.image2)return null}return e})}),(0,o._)(this,"unwrapPastedBlockquotes",async(e,t,i)=>{if(!i)return t;let o=t.content.toJSON();if((null==o?void 0:o[0].type)!=="blockquote")return t;try{let e=E()(i.state.selection.$head,"path");if(!(null==e?void 0:e.length))return t;let o=e.filter(e=>{var t;return"number"!=typeof e&&(null===(t=e.type)||void 0===t?void 0:t.name)==="blockquote"});if(!o)return t;let a=o.length;return await (0,Y.hL)(t,e=>{if("blockquote"===e.type.name){let i;a++;let o=e;for(;!i&&o;){var t;let e=(0,tZ.yX)({fragment:o.content})[0];if((null==e?void 0:null===(t=e.type)||void 0===t?void 0:t.name)==="text"){i=e;break}o=e}if(i&&a>5)return i}return e})}catch(e){console.error("Failed to convert nested blockquote to paragraph",e)}return t}),(0,o._)(this,"cleanBadPastedMarks",async(e,t)=>{let i=e.state.schema;return(0,Y.je)(t,e=>{e.marks&&e.marks.length>0&&(e.type.isBlock&&e.content&&0===(0,tZ.yX)({fragment:e.content}).length?(0,tZ.SK)({node:e,marks:[]}):["image2","twitter2","youtube2","spotify2","horizontal_rule","horizontalRule"].includes(e.type.name)&&(0,tZ.SK)({node:e,marks:[]}))}),t=await (0,Y.hL)(t,async(e,t)=>{var o;return(null===(o=e.attrs)||void 0===o?void 0:o.empty)||e.type===i.nodes.paywall||[i.nodes.hard_break,i.nodes.hardBreak].includes(e.type)&&0===t||[i.nodes.paragraph,i.nodes.heading].includes(e.type)&&""===e.textContent.trim()?null:e}),t=(0,Y.I_)(t,e=>e.type===i.nodes.blockquote),E()(e,"shiftKey")&&(t=(0,Y.I_)(t,e=>e.type===i.nodes.paragraph,e=>{for(let t=e.length-1;t>0;t--)i.nodes.paragraph&&i.nodes.hard_break&&e.splice(t,0,i.nodes.paragraph.create({},[i.nodes.hard_break.create()]));return e})),(0,Y.je)(t,e=>{if(e.marks){for(let t of e.marks)if(t.type===i.marks.link&&t.attrs.href&&t.attrs.href.startsWith("/")&&!t.attrs.href.startsWith("//")){let e="".concat(window.location.protocol,"//").concat(window.location.host).concat(t.attrs.href);(0,tZ.mR)({node:t,attrs:{href:e}})}}}),t}),(0,o._)(this,"maybeGetSliceUrl",e=>{var t,i;let{schema:o,slice:a}=e,s=null===(t=(0,tZ.yX)({fragment:a.content}))||void 0===t?void 0:t[0];if(!s)return!1;let n=null===(i=(0,tZ.yX)({fragment:s.content}))||void 0===i?void 0:i[0];if(!n||n.type!==o.nodes.text)return!1;let r=n.text;return!T()(r)&&(0,en.en2)(r)}),(0,o._)(this,"maybeLinkSelectedText",(e,t)=>{let i=this.maybeGetSliceUrl({schema:e.state.schema,slice:t});if(!i)return;let o=e.state.selection;if(!(o instanceof g.Bs&&o.from!==o.to)||!e.state.schema.marks.link)return;let a=e.state.tr;return a.addMark(o.from,o.to,e.state.schema.marks.link.create({href:i.toString()})),a}),(0,o._)(this,"augmentPastedContent",async(e,t)=>{t=await (0,Y.hL)(t,t=>t.type!==e.state.schema.nodes.text?t:this.augmentPastedText({schema:e.state.schema,text:t.text}).map(i=>{if("string"!=typeof i)return i;if(!i)return null;let o=e.state.schema.text(i,t.marks);return(0,tZ.Iy)({node:o,text:i}),o})),this.processAugmentationPlaceholders(e,t);let i=(0,tE.purgeUnsafeLinks)(t);return i||t}),(0,o._)(this,"augmentPastedText",e=>{let{schema:t,text:i}=e;if(!i)return[];let[o,a]=(0,$.WB)(i,t,void 0);if(!o)return[i];let s="boolean"==typeof o?[i]:i.split(o);if(o===i||1===s.length)return[a];for(let e=s.length-1;e>=0;e-=1){let i=s[e];if("string"!=typeof i)continue;e>0&&(i=i.trimStart()),e<s.length-1&&(i=i.trimEnd());let o=this.augmentPastedText({schema:t,text:i});e&&o.unshift(a),s.splice(e,1,...o)}return s}),(0,o._)(this,"processAugmentationPlaceholders",(e,t)=>{(0,Y.je)(t,t=>(0,$.rN)(t,e,e.state.schema).catch(e=>alert((0,L.zx)(e))),{nodeTypes:["augmentation_placeholder"]})}),(0,o._)(this,"maybeAddNewline",(e,t,i,o)=>{var a;(null===(a=(0,tZ.yX)({fragment:i.content})[0])||void 0===a?void 0:a.type.name)==="file"&&o&&setTimeout(()=>{e.state.doc.nodeAt(e.state.doc.nodeSize-3)===(0,tZ.yX)({fragment:i.content})[0]&&e.dispatch(e.state.tr.insertText("\r",e.state.doc.nodeSize-2))},0)}),(0,o._)(this,"handleDrop",(e,t,i,o)=>{if(!t.dataTransfer)return!1;if(t.dataTransfer.files&&t.dataTransfer.files.length)return this.onDropFile(t),!0;let a=t.dataTransfer.getData("URL");if(!a)return this.maybeAddNewline(e,t,i,o),!1;let s=this.getInsertPos(t);return s?this.insertImage({schema:e.state.schema,pos:s,image:a}):console.warn("could not find insert position for drop event"),!0}),(0,o._)(this,"allowDropFile",e=>{e.preventDefault()}),(0,o._)(this,"onDropFile",async(e,t)=>{var i,o;e.preventDefault();let n=t||Array.from(null!==(o=null===(i=e.dataTransfer)||void 0===i?void 0:i.files)&&void 0!==o?o:[]),r=[];await Promise.all(n.map(async t=>{if(!this.acceptFile(t)){r.push(t);return}await this.dropFile(t,this.getInsertPos(e)).catch(e=>{r.push((0,s._)((0,a._)({},t),{error:e}))})})),r.length>0&&this.handleDropFileErrors(r)}),(0,o._)(this,"dropFile",async(e,t)=>!!e.type.startsWith("image/")&&this.insertImageFile(e,t)),(0,o._)(this,"openPodcastPaywallMenu",()=>{let e=document.querySelector(".podcastPaywallMenuButton");e&&this.triggerMouseEvent(e,"click")}),(0,o._)(this,"openInsertMenu",()=>{let e=document.querySelector(".more-dropdown");e&&this.triggerMouseEvent(e,"click")}),(0,o._)(this,"acceptFile",e=>{let{iString:t=e=>e}=this.props;return e.size>er.MAX_FILE_SIZE?(e.error=Error(t("File Too Large")),e.error.details=(0,d.BX)(R.xv.B3,{translated:!0,children:["We were unable to add ",(0,d.tZ)("b",{children:I18N.p(e.name)})," because it is larger than"," ",I18N.p((0,er.numberToHumanFileSize)(er.MAX_FILE_SIZE)),". Try reducing the file size and adding again."]}),!1):!!e.type.startsWith("image/")}),(0,o._)(this,"handleDropFileErrors",e=>{let t=[...e,...this.state.errors||[]];this.setState({errors:t})}),(0,o._)(this,"insertImageFile",async(e,t)=>{if(!this.editorView)return!1;if(!e)return console.warn("insertImageFile received a null file"),!1;null==t&&(t=this.editorView.state.selection.from);let i=await (0,L.Zk)(e);return this.insertImage({schema:this.editorView.state.schema,pos:t,image:i,imageType:e.type}),!0}),(0,o._)(this,"getInsertPos",e=>{if(!this.editorView)return;let t=this.editorView.state.tr.doc.content.size;if(e){let i=this.editorView.dom.getBoundingClientRect(),o=this.editorView.posAtCoords({left:Math.max(i.left,Math.min(i.right,e.clientX)),top:Math.max(i.top,Math.min(i.bottom,e.clientY))});o&&(t=o.pos)}return t}),(0,o._)(this,"uploadImage",async(e,t)=>{var i,o;let a,s;try{if(this.setState(e=>({pendingUploads:e.pendingUploads+1})),e.startsWith("blob:")){let i=await (0,L.Br)(e);e=await (0,L.Zk)(i),t=i.type}let i=(null===(o=this.state.post)||void 0===o?void 0:o.id)||this.props.post_id;s=await I().post("/api/v1/image").send({image:e,postId:i}),a=await new Promise(e=>(0,L.pt)((0,tT.kC)({attrs:{type:null!=t?t:null,src:s.body.url}}),e))}finally{this.setState(e=>({pendingUploads:e.pendingUploads-1}))}let n=(null===(i=this.state.post)||void 0===i?void 0:i.id)||this.props.post_id,r=new URLSearchParams({img:s.body.url}),d="".concat((0,en.SVA)(this.props.pub),"/i/").concat(n,"?").concat(r);return(0,tT.Nh)(a,null!=t?t:null,{bytes:s.body.bytes,internalRedirect:d})}),(0,o._)(this,"getHostedImageAttrs",async e=>{let t=await new Promise(t=>(0,L.pt)((0,tT.kC)({attrs:{src:e,type:null}}),t));return(0,tT.Nh)(t,null,{})}),(0,o._)(this,"insertImage",e=>{let{pos:t,image:i,imageType:o,schema:a}=e,{iString:s=e=>e}=this.props;if(!this.editorView){console.warn("insertImage called without an editorView");return}let n=es.Z.add(this.editorView,t,i);this.uploadImage(i,o).then(e=>{if(!this.editorView){console.warn("insertImage called without an editorView");return}if(!a.nodes.captionedImage||!a.nodes.image2){console.warn("missing captionedImage or image2 node in schema");return}let t=a.nodes.captionedImage.create(e,a.nodes.image2.create(e));es.Z.replace(this.editorView,n,t)}).catch(e=>{413===e.status?alert(s("Image too Large")):"args[0].toLowerCase is not a function"===e.message?alert(s("Failed to process image. If you have the DuckDuckGo browser extension installed, please disable it and try again. If the issues persists, please contact support.")):alert((0,L.zx)(e,"There was a network issue. Try again in a bit")),this.editorView&&es.Z.remove(this.editorView,n)})}),(0,o._)(this,"getCoupons",async()=>this.props.pub?(await I().get("/api/v1/coupon").query({limit:5})).body:[]),(0,o._)(this,"insertCoupon",e=>{var t,i,o,n,r,d;let l,{coupon:c,schema:h,state:u=null,dispatch:p=null}=e,{iTemplate:v=tw.u8}=this.props,m=(0,to.HL)(c),g=(null===(i=this.state)||void 0===i?void 0:null===(t=i.post)||void 0===t?void 0:t.id)||this.props.post_id;if(l="EXTRA_SEATS"===m?(0,tb.n1t)("".concat(this.props.pub.base_url,"/account"),{coupon:c.id,extra_seats:!0,utm_content:g}):(0,tb.n1t)("".concat(this.props.pub.base_url,"/subscribe"),(0,s._)((0,a._)({coupon:c.id},c.group_only&&{group:!0}),{utm_content:g})),!(u=null!==(r=u||(null===(o=this.editorView)||void 0===o?void 0:o.state))&&void 0!==r?r:null)){console.warn("insertCoupon called without editor state");return}if(!(p=null!==(d=p||(null===(n=this.editorView)||void 0===n?void 0:n.dispatch))&&void 0!==d?d:null)){console.warn("insertCoupon called without a dispatch function");return}if(!h.nodes.button){console.warn("button does not exist");return}p((0,Y.o4)(u,h.nodes.button.create({url:l,text:v(tx(),(0,L.ig)(c)||"")})))}),(0,o._)(this,"fileEditStart",(e,t)=>{let i=t.detail.node;this.setState({fileEdit:i})}),(0,o._)(this,"fileEditDone",()=>{this.setState({fileEdit:null}),this.onEdit()}),(0,o._)(this,"imageWatermarkStart",(e,t)=>{this.setState({imageToWatermark:{node:E()(t,"node"),pos:E()(t,"pos"),view:E()(t,"view")}})}),(0,o._)(this,"imageWatermarkDone",()=>{this.setState({imageToWatermark:null}),this.onEdit()}),(0,o._)(this,"setPostPaidForPaywall",()=>{if(!this.state.audienceToggle){console.warn("setPostPaidForPaywall called without an audienceToggle");return}(0,t_.isPaidAudience)(this.state.audienceToggle)||this.setState({audienceToggle:"only_paid"})}),(0,o._)(this,"setPostId",async()=>{var e,t;let{iString:i=e=>e}=this.props,o=(null===(t=this.state)||void 0===t?void 0:null===(e=t.post)||void 0===e?void 0:e.id)||this.props.post_id,a=0;for(;!o&&a<3;)a++,(o=await this.save({saveDocumentOptions:{forceSave:!0}}))||await new Promise(e=>setTimeout(e,200));return o||(window.alert(i("Something went wrong. Please refresh the page.")),null)}),(0,o._)(this,"removeVoiceover",function(){let{skipConfirm:e=!1}=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},{iString:t=e=>e}=i.props;(e||confirm(t("This change will permanently remove the voiceover audio. Are you sure?")))&&i.setState({doc:(0,s._)((0,a._)({},i.state.doc),{voiceover_upload_id:null,voiceoverUpload:null})},async()=>{await i.save()})}),(0,o._)(this,"removeVideoPreview",async()=>{if(!this.state.doc)return;let{video_upload_id:e}=this.state.doc;if(e)try{let t=await I().delete("/api/v1/video/upload/".concat(e,"/preview"));this.setState({doc:(0,s._)((0,a._)({},this.state.doc),{video_upload_id:this.state.doc.video_upload_id,videoUpload:(0,a._)({},this.state.doc.videoUpload,t.body)})},async()=>{await this.save({saveDocumentOptions:{forceSave:!0}})})}catch(e){alert((0,L.zx)(e))}}),(0,o._)(this,"removePodcastPreview",function(){let{skipConfirm:e}=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{skipConfirm:!1},{iString:t=e=>e}=i.props;if(!i.state.doc)return;let{podcast_preview_upload_id:o,podcastPreviewUpload:n}=i.state.doc;o&&(e||null==n||!n.state||["cancelled","error"].includes(n.state)||confirm(t("This change will permanently remove the free audio. Are you sure?")))&&i.setState({doc:(0,s._)((0,a._)({},i.state.doc),{podcast_preview_upload_id:null,podcastPreviewUpload:null})},async()=>{await i.save({saveDocumentOptions:{forceSave:!0}})})}),(0,o._)(this,"removeLegacyPodcast",()=>{let{iString:e=e=>e}=this.props;return!!confirm(e("This will permanently remove your audio. Are you sure?"))&&!!this.state.doc&&(this.setState({doc:(0,s._)((0,a._)({},this.state.doc),{podcast_url:null,podcast_duration:null})},async()=>{await this.save({saveDocumentOptions:{forceSave:!0}})}),!0)}),(0,o._)(this,"removePodcast",function(){let{skipConfirm:e=!1}=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},{iString:t=e=>e}=i.props;if(!i.state.doc){console.warn("doc not set in removePodcast");return}let{podcast_preview_upload_id:o}=i.state.doc,n=t(o?"This change will permanently remove both the free and paid audio from the post. Are you sure?":"This change will permanently remove your audio. Are you sure?");(e||confirm(n))&&i.setState({doc:(0,s._)((0,a._)({},i.state.doc),{podcastUpload:null,podcast_upload_id:null,podcastPreviewUpload:null,podcast_preview_upload_id:null})},()=>{i.onEdit({force:!0})})}),(0,o._)(this,"removeVideoPodcast",function(){let{skipConfirm:e=!1}=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},{iString:t=e=>e}=i.props,o=t(i.hasVideoPaywall()?"This change will permanently remove both the free and paid video from the post. Are you sure?":"This change will permanently remove your video. Are you sure?");(e||confirm(o))&&i.setState({doc:(0,s._)((0,a._)({},i.state.doc),{videoUpload:null,video_upload_id:null,podcastUpload:null,podcast_upload_id:null,podcastPreviewUpload:null,podcast_preview_upload_id:null})},()=>{i.onEdit({force:!0})})}),(0,o._)(this,"onPodcastUploadChanged",e=>{let{mediaUpload:t,podcastPreviewUpload:i,removePreview:o}=e,n=(null==t?void 0:t.state)==="error"?{hideFromFeed:!0}:{};this.setState(e=>({podcastUploading:!1,doc:(0,a._)((0,s._)((0,a._)({},e.doc),{podcast_upload_id:(null==t?void 0:t.id)||null,podcastUpload:t}),o?{podcast_preview_upload_id:null,podcastPreviewUpload:null}:{},i?{podcast_preview_upload_id:i.id,podcastPreviewUpload:i}:{},n)}),()=>{this.onEdit({force:!0})})}),(0,o._)(this,"onPodcastPreviewUploadChanged",e=>{let{mediaUpload:t}=e,i=(null==t?void 0:t.state)==="error"?{hideFromFeed:!0}:{};this.setState(e=>({podcastPreviewUploading:!1,doc:(0,a._)((0,s._)((0,a._)({},e.doc),{podcast_preview_upload_id:(null==t?void 0:t.id)||null,podcastPreviewUpload:t}),i)}),()=>{this.onEdit({force:!0})})}),(0,o._)(this,"onVideoPodcastUploadChanged",e=>{let{mediaUpload:t,podcastUpload:i,podcastPreviewUpload:o}=e,s={video_upload_id:(null==t?void 0:t.id)||null,videoUpload:t};void 0!==i&&(s.podcast_upload_id=(null==i?void 0:i.id)||null,s.podcastUpload=i),void 0!==o&&(s.podcast_preview_upload_id=(null==o?void 0:o.id)||null,s.podcastPreviewUpload=o),this.setState(e=>({podcastUploading:!1,doc:(0,a._)({},e.doc,s)}),async()=>{setTimeout(()=>{this.onEdit({force:!0})},1e3)})}),(0,o._)(this,"onVoiceoverUploadChanged",e=>{this.setState(t=>({doc:(0,s._)((0,a._)({},this.state.doc),{voiceover_upload_id:(null==e?void 0:e.id)||null,voiceoverUpload:e})}),()=>{this.onEdit({force:!0})})}),(0,o._)(this,"updateDigestPostEmbed",e=>{var t;let i=e.detail,{shouldDisableDrag:o}=i,a=(0,n._)(i,["shouldDisableDrag"]);null===(t=this.tipTapEditor)||void 0===t||t.chain().focus().updateDigestPostEmbed(a,o).run()}),(0,o._)(this,"convertDigestPostEmbedToLink",e=>{var t;null===(t=this.tipTapEditor)||void 0===t||t.chain().focus().convertDigestPostEmbedToLink(e.detail).run()}),(0,o._)(this,"convertDigestPostEmbedToEmbeddedPost",e=>{var t;null===(t=this.tipTapEditor)||void 0===t||t.chain().focus().convertDigestPostEmbedToEmbeddedPost(e.detail).run()}),(0,o._)(this,"deleteDigestPostEmbed",()=>{var e;null===(e=this.tipTapEditor)||void 0===e||e.chain().focus().deleteDigestPostEmbed().run()}),this.editorView=null,this.autoSaveEnabled=!0,this.commandSaveEnabled=!0,this.state={loaded:!1,pendingUploads:0},this.onEdit=this.onEdit.bind(this),this.isMounted=!1}}},39556:function(e,t,i){async function o(e,t){let{editImage:o}=await Promise.all([i.e("6666"),i.e("4769")]).then(i.bind(i,71682));return o(e,t)}async function a(e,t){let{editImageAndRehost:o}=await Promise.all([i.e("6666"),i.e("4769")]).then(i.bind(i,71682));return o(e,t)}i.d(t,{N:()=>a,O:()=>o})},77203:function(e,t,i){i.d(t,{U:()=>d});var o=i(16584),a=i(94184),s=i.n(a),n=i(80026);let r={callout:"callout-d07Rfu",default:"default-Bn05cP",warn:"warn-_YYgsC"};function d(e){let{type:t="default",icon:i,title:a,action:d}=e;return(0,o.BX)(n.X2,{className:s()(r.callout,r[t]),gap:12,paddingY:12,paddingX:16,alignItems:"center",radius:"md",sizing:"border-box",children:[i({size:20}),(0,o.tZ)(n.xv.B3,{weight:"semibold",flex:"grow",children:a}),d]})}},55077:function(e,t,i){i.d(t,{k:()=>n});var o=i(16584);let a={green:"var(--color-data-green)","primary-themed":"var(--color-primary-themed)"},s={green:"var(--color-light-bg-tertiary)","primary-themed":"var(--color-bg-tertiary-themed)"},n=e=>{let{color:t="green",forcePercentage:i,value:n,width:r=147}=e;return(0,o.BX)("div",{style:{width:"".concat(r,"px")},children:[(0,o.tZ)("div",{className:"progressBar-ZkHHkr",style:{backgroundColor:s[t]}}),(0,o.tZ)("div",{className:"progressBarValue-_VHShe",style:{width:"".concat((n<=1&&!i?n:n/100)*r,"px"),backgroundColor:a[t]}})]})}}}]);